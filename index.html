<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AyurSutra - Modern Ayurvedic Patient Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="icon" type="image/png" sizes="32x32" href="/logo.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/logo.png">
    <link rel="icon" type="image/png" sizes="128x128" href="/logo.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/logo.png">
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#368D8B", // Fresh, modern teal
              secondary: "#FF7A5C", // Vibrant coral accent
              accent: "#A0D2DB", // Soft, light teal
              tertiary: "#F4E9D8", // Warm sand for backgrounds
              background: "#FCFBF9", // Clean, warm off-white
              "text-primary": "#2c3e50", // Dark charcoal for readability
              "text-secondary": "#576c7a", // Softer grey-blue
              // Dark theme colors for consistency
              "d-primary": "#319795",
              "d-secondary": "#dd6b20",
              "d-accent": "#4fd1c5",
              "d-background": "#1a202c",
              "d-surface": "#2d3748",
              "d-text-primary": "#ffffff",
              "d-text-secondary": "#a0aec0",
            },
          },
        },
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
      body {
        background-color: #f4e9d8;
        font-family: "Poppins", ui-sans-serif, system-ui, -apple-system,
          "Segoe UI", Roboto, "Helvetica Neue", Arial;
        color: #2c3e50;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      .dark body {
        background-color: #1a202c;
        color: #ffffff;
      }

      body.login-active::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image: url(back5.png);
        background-repeat: repeat;
        opacity: 0.4;
        z-index: -1;
      }

      .dark .text-text-primary,
      .dark .text-text-secondary {
        color: #ffffff;
      }

      .card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02),
          0 5px 15px rgba(0, 0, 0, 0.06);
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      .dark .card {
        background: rgba(45, 55, 72, 0.7);
        border-color: rgba(255, 255, 255, 0.1);
      }
      .focus-ring:focus {
        outline: 2px solid #a0d2db;
        outline-offset: 2px;
      }
      .dark .focus-ring:focus {
        outline-color: #4fd1c5;
      }

      .btn {
        transition: all 0.25s ease;
      }
      .btn-primary {
        background-color: #368d8b;
        color: white;
      }
      .dark .btn-primary {
        background-color: #319795;
      }
      .btn-primary:hover {
        background-color: #2a6f6d;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(54, 141, 139, 0.25);
      }
      .dark .btn-primary:hover {
        background-color: #2c7a7b;
        box-shadow: 0 4px 12px rgba(49, 151, 149, 0.25);
      }

      .btn-secondary {
        background-color: #ff7a5c;
        color: white;
      }
      .dark .btn-secondary {
        background-color: #dd6b20;
      }
      .btn-secondary:hover {
        background-color: #e66a4f;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 122, 92, 0.3);
      }
      .dark .btn-secondary:hover {
        background-color: #c05621;
        box-shadow: 0 4px 12px rgba(221, 107, 32, 0.3);
      }

      .therapy-card {
        position: relative;
        overflow: hidden;
      }
      .therapy-card::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.05'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
        pointer-events: none;
        z-index: 0;
      }
      .therapy-card > * {
        position: relative;
        z-index: 1;
      }
      .lang-btn {
        background-color: transparent;
        color: #576c7a; /* text-secondary */
        transition: all 0.2s ease;
        border: 1px solid transparent;
      }
      .dark .lang-btn {
        color: #a0aec0;
      }

      .lang-btn.active {
        background-color: rgba(54, 141, 139, 0.1); /* primary/10 */
        color: #368d8b; /* primary */
        font-weight: 600;
      }
      .dark .lang-btn.active {
        background-color: rgba(49, 151, 149, 0.2);
        color: #319795;
      }
      .lang-btn:not(.active):hover {
        background-color: rgba(0, 0, 0, 0.05);
      }
      .dark .lang-btn:not(.active):hover {
        background-color: rgba(255, 255, 255, 0.05);
      }
       /* Scrollbar styles for chat and other scrollable areas */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.2);
        border-radius: 10px;
      }
      .dark .custom-scrollbar::-webkit-scrollbar-thumb {
         background-color: rgba(255,255,255,0.2);
      }
    </style>
  </head>
  <body
    class="min-h-screen flex items-center justify-center p-4 lg:p-8 login-active"
  >
    <div id="app" class="w-full max-w-7xl">
      <!-- MAIN LOGIN SCREEN -->
      <main
        id="screen-login"
        class="mx-auto max-w-5xl p-8 card rounded-3xl text-center"
      >
        <div class="mb-3">
          <!-- Make logo smaller -->
          <img src="logo.png" alt="AyurSutra Logo" class="w-32 mx-auto" />
        </div>
        <div class="my-6">
          <!-- Make home2.png bigger -->
          <img
            src="home2.png"
            alt="Holistic wellness illustration"
            class="w-128 h-auto mx-auto"
          />
        </div>
        <p class="text-text-secondary mb-8">
          Your journey to holistic wellness starts here.
        </p>
        <div class="space-y-4">
          <button
            id="btn-patient-login"
            class="w-96 py-3 rounded-full mr-4 btn btn-primary font-semibold text-lg"
          >
            Patient Login
          </button>
          <button
            id="btn-practitioner-login"
            class="w-96 py-3 rounded-full btn btn-secondary font-semibold text-lg"
          >
            Practitioner Login
          </button>
        </div>
        <div
          id="language-picker"
          class="mt-8 flex justify-center items-center gap-2"
        >
          <button
            data-lang="en"
            class="lang-btn active px-3 py-1 text-sm rounded-full"
          >
            English
          </button>
          <button
            data-lang="hi"
            class="lang-btn px-3 py-1 text-sm rounded-full"
          >
            हिन्दी
          </button>
          <button
            data-lang="bn"
            class="lang-btn px-3 py-1 text-sm rounded-full"
          >
            বাংলা
          </button>
          <button
            data-lang="or"
            class="lang-btn px-3 py-1 text-sm rounded-full"
          >
            ଓଡ଼ିଆ
          </button>
        </div>
      </main>

      <!-- MAIN APPLICATION SHELL -->
      <div id="app-shell" class="hidden">
        <header class="flex items-center justify-between mb-8">
          <div class="flex items-center gap-4">
            <h2
              id="app-title"
              class="text-3xl font-bold text-text-primary tracking-tight"
            >
              Dashboard
            </h2>
          </div>
          <div class="flex items-center gap-4">
            <button
              id="btn-learn"
              class="btn btn-primary px-5 py-2 rounded-full focus-ring font-semibold hidden"
              data-translate="learn"
            >
              Learn
            </button>
            <button
              id="btn-find-clinics"
              class="btn btn-secondary px-5 py-2 rounded-full focus-ring font-semibold hidden"
              data-translate="findClinics"
            >
              Clinics Around Me
            </button>
            <div
              id="user-badge"
              class="px-4 py-2 rounded-full bg-white/70 dark:bg-slate-700/70 shadow-sm text-sm font-semibold"
            ></div>

            <!-- NEW: Chat/Messages Button -->
             <button id="btn-messages" title="Messages" class="p-2 rounded-full bg-white/70 dark:bg-slate-700/70 hover:bg-white/90 dark:hover:bg-slate-600/90">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
            </button>

            <!-- NEW: Notifications Bell -->
            <div id="notification-bell-container" class="relative">
                <button id="btn-notifications" title="Notifications" class="p-2 rounded-full bg-white/70 dark:bg-slate-700/70 hover:bg-white/90 dark:hover:bg-slate-600/90">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    <div id="notification-indicator" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-background dark:border-d-background hidden"></div>
                </button>
                <div id="notification-popover" class="hidden absolute right-0 mt-2 w-80 bg-background dark:bg-d-surface card rounded-2xl shadow-xl z-50 overflow-hidden">
                    <div class="p-4 border-b border-gray-200/50 dark:border-slate-700">
                        <h4 class="font-semibold text-text-primary">Notifications</h4>
                    </div>
                    <div id="notification-list" class="max-h-96 overflow-y-auto custom-scrollbar">
                        <!-- Notifications will be rendered here -->
                    </div>
                </div>
            </div>

            <button
              id="theme-toggle"
              class="p-2 rounded-full bg-white/70 dark:bg-slate-700/70 hover:bg-white/90 dark:hover:bg-slate-600/90"
            >
              <svg
                id="theme-toggle-dark-icon"
                class="hidden w-5 h-5"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
                ></path>
              </svg>
              <svg
                id="theme-toggle-light-icon"
                class="hidden w-5 h-5"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z"
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                ></path>
              </svg>
            </button>
            <button
              id="btn-logout"
              class="px-5 py-2 rounded-full bg-white/70 dark:bg-slate-700/70 border border-gray-200/50 dark:border-slate-600 hover:bg-white dark:hover:bg-slate-600 focus-ring font-semibold"
            >
              Logout
            </button>
          </div>
        </header>

        <!-- PATIENT DASHBOARD -->
        <section id="dashboard-patient" class="hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <aside class="card p-6 rounded-3xl">
              <div class="flex items-start justify-between">
                <div>
                  <h3
                    class="text-2xl font-bold tracking-tight"
                    id="patient-name-display"
                  >
                    Patient Name
                  </h3>
                  <p
                    class="text-sm text-text-secondary"
                    id="patient-id-display"
                  >
                    ID: P-001
                  </p>
                </div>
                <div class="flex flex-col gap-2 items-end">
                  <button
                    id="history-btn"
                    class="text-sm px-3 py-1 rounded-md bg-secondary/20 hover:bg-secondary/30 dark:bg-orange-400/20 dark:hover:bg-orange-400/30"
                  >
                    History
                  </button>
                  <button
                    id="edit-patient"
                    class="text-sm px-3 py-1 rounded-md bg-secondary/20 hover:bg-secondary/30 dark:bg-orange-400/20 dark:hover:bg-orange-400/30"
                  >
                    Edit
                  </button>
                </div>
              </div>
              <dl class="mt-6 text-sm text-text-secondary space-y-3">
                <div class="flex justify-between">
                  <span
                    class="font-semibold text-text-primary"
                    data-translate="age"
                    >Age</span
                  > <span id="patient-age">29</span>
                </div>
                <div class="flex justify-between">
                  <span
                    class="font-semibold text-text-primary"
                    data-translate="gender"
                    >Gender</span
                  > <span id="patient-gender">Female</span>
                </div>
                <div class="flex justify-between">
                  <span
                    class="font-semibold text-text-primary"
                    data-translate="contact"
                    >Contact</span
                  > <span id="patient-contact">+91 98765 43210</span>
                </div>
                <div class="flex justify-between">
                  <span
                    class="font-semibold text-text-primary"
                    data-translate="nextAppointment"
                    >Next Appointment</span
                  > <span id="patient-next" class="font-semibold">—</span>
                </div>
                <div>
                  <span
                    class="font-semibold text-text-primary"
                    data-translate="conditions"
                    >Conditions</span
                  >
                  <div
                    id="patient-conditions"
                    class="mt-2 flex flex-wrap gap-2"
                  ></div>
                </div>
              </dl>
            </aside>

            <div class="lg:col-span-2 space-y-8">
              <div class="card p-6 rounded-3xl">
                <h3
                  class="text-xl font-bold mb-4 tracking-tight"
                  data-translate="assistantTitle"
                >
                  AyurSutra Assistant
                </h3>
                <div>
                  <textarea
                    id="issue-text"
                    rows="4"
                    data-translate-placeholder="issuePlaceholder"
                    placeholder="e.g., 'I have been experiencing frequent headaches and shoulder stiffness.'"
                    class="w-full p-3 rounded-lg border-gray-200/50 dark:border-slate-600 bg-background/50 dark:bg-slate-800/50 focus-ring"
                  ></textarea>
                </div>
                <div class="mt-4 flex items-center gap-4 flex-wrap">
                  <button
                    id="btn-send-llm"
                    class="px-6 py-2 rounded-full btn btn-primary font-semibold"
                    data-translate="findSpecialist"
                  >
                    Find a Specialist
                  </button>
                  <div
                    id="llm-loading"
                    class="hidden text-sm text-text-secondary"
                    data-translate="searching"
                  >
                    Searching…
                  </div>
                  <div id="llm-msg" class="text-sm text-text-secondary"></div>
                </div>
                <div
                  id="doctor-results"
                  class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4"
                ></div>
              </div>

              <div class="card p-6 rounded-3xl">
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-xl font-bold tracking-tight"
                    data-translate="currentTherapies"
                  >
                    Current Therapies
                  </h3>
                </div>
                <div id="current-therapies-list" class="space-y-4"></div>
              </div>

              <div class="card p-6 rounded-3xl">
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-xl font-bold tracking-tight"
                    data-translate="upcomingSessions"
                  >
                    Upcoming Sessions
                  </h3>
                  <div
                    class="text-sm text-text-secondary"
                    id="upcoming-session-meta"
                  >
                    No sessions
                  </div>
                </div>
                <div id="upcoming-session" class="space-y-3"></div>
              </div>
              
              <!-- NEW: Document Upload Section -->
              <div class="card p-6 rounded-3xl">
                  <div class="flex items-center justify-between mb-4">
                      <h3 class="text-xl font-bold tracking-tight">My Documents</h3>
                      <label for="doc-upload-input" class="cursor-pointer px-4 py-2 rounded-full btn btn-primary font-semibold text-sm">
                          Upload File
                      </label>
                      <input type="file" id="doc-upload-input" class="hidden" />
                  </div>
                  <div id="document-list" class="space-y-3">
                      <!-- Document list will be rendered here by JS -->
                  </div>
              </div>


              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card p-6 rounded-3xl">
                  <h3
                    class="text-xl font-bold mb-4 tracking-tight"
                    data-translate="wellnessProgress"
                  >
                    Wellness Progress
                  </h3>
                  <canvas id="wellnessChart" height="150"></canvas>
                  <div
                    id="wellness-metrics"
                    class="mt-4 grid grid-cols-2 gap-4"
                  ></div>
                </div>

                <div class="card p-6 rounded-3xl">
                  <h3
                    class="text-xl font-bold mb-4 tracking-tight"
                    data-translate="therapies"
                  >
                    Therapies
                  </h3>
                  <div
                    id="therapies-board"
                    class="grid grid-cols-2 gap-4"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- PRACTITIONER DASHBOARD -->
        <section id="dashboard-practitioner" class="hidden">
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="lg:col-span-1 card p-6 rounded-3xl">
              <h3
                class="text-xl font-bold mb-4 tracking-tight"
                data-translate="patients"
              >
                Patients
              </h3>
              <div class="flex items-center gap-2 mb-4">
                <input
                  id="pract-search"
                  class="w-full px-3 py-2 border border-gray-200/50 dark:border-slate-600 bg-background/50 dark:bg-slate-800/50 rounded-lg focus-ring"
                  data-translate-placeholder="searchPatientsPlaceholder"
                  placeholder="Search patients..."
                />
                <button
                  id="pract-search-go"
                  class="p-2 rounded-md bg-secondary/20 hover:bg-secondary/30 dark:bg-orange-400/20 dark:hover:bg-orange-400/30"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 1014 0z"
                    ></path>
                  </svg>
                </button>
              </div>
              <div
                id="pract-patient-list"
                class="space-y-3 max-h-[60vh] overflow-auto custom-scrollbar"
              ></div>
            </div>

            <div class="lg:col-span-3 card p-6 rounded-3xl">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-4">
                  <h3
                    class="text-xl font-bold tracking-tight"
                    id="calendar-title"
                  ></h3>
                  <div class="flex items-center gap-1">
                    <button
                      id="cal-prev"
                      class="p-1 rounded-md hover:bg-gray-200/50 dark:hover:bg-slate-600"
                    >
                      &lt;
                    </button>
                    <button
                      id="cal-next"
                      class="p-1 rounded-md hover:bg-gray-200/50 dark:hover:bg-slate-600"
                    >
                      &gt;
                    </button>
                  </div>
                </div>
              </div>
              <div
                id="calendar-grid"
                class="grid grid-cols-7 gap-1 text-center text-sm"
              >
                <!-- Calendar will be rendered here by JS -->
              </div>
            </div>

            <div class="lg:col-span-4 card p-6 rounded-3xl">
              <h3
                class="text-xl font-bold mb-4 tracking-tight"
                data-translate="recentFeedback"
              >
                Recent Feedback
              </h3>
              <div
                id="pract-feedback-list"
                class="space-y-4 max-h-[40vh] overflow-auto custom-scrollbar"
              >
                <!-- JS will render feedback here -->
              </div>
            </div>
          </div>

          <div
            id="pract-slide"
            class="fixed right-8 top-24 w-[400px] max-w-full h-[85vh] card p-6 rounded-3xl shadow-2xl hidden z-50 overflow-auto custom-scrollbar"
          >
            <div class="flex items-center justify-between mb-4">
              <h4
                class="text-xl font-bold tracking-tight"
                data-translate="patientDetails"
              >
                Patient Details
              </h4>
              <button
                id="pract-close-slide"
                class="px-2 py-1 rounded-md hover:bg-gray-200/50 dark:hover:bg-slate-600"
                data-translate="close"
              >
                Close
              </button>
            </div>
            <div id="pract-slide-body"></div>
          </div>
        </section>
      </div>

      <div id="modal-root"></div>
      <div
        aria-live="polite"
        id="toast"
        class="fixed bottom-8 left-8 z-50"
      ></div>
    </div>

    <script>
      const state = {
        currentUser: null,
        currentLanguage: "en",
        currentCalendarDate: new Date("2025-09-21T09:00:00"),
        // NEW: Notifications data
        notifications: [],
        // NEW: Chat/Messages data
        messages: [
            {
                id: 'MSG-001',
                participants: ['P-001', 'D-01'],
                conversation: [
                    { sender: 'D-01', text: 'Hello Ananya, how are you feeling after the last session?', timestamp: '2025-09-20T10:00:00' },
                    { sender: 'P-001', text: 'Much better, doctor. The headaches have reduced. Thank you!', timestamp: '2025-09-20T10:05:00' },
                    { sender: 'D-01', text: 'That is excellent news. Please continue with the prescribed herbal supplements.', timestamp: '2025-09-20T10:06:00' },
                ]
            },
            {
                id: 'MSG-002',
                participants: ['P-002', 'D-03'],
                conversation: [
                    { sender: 'D-03', text: 'Rohit, remember to avoid heavy lifting for the next week as we discussed.', timestamp: '2025-09-19T15:00:00' },
                ]
            }
        ],
        feedback: [
          {
            patientId: "P-001",
            practitionerName: "Dr. Suresh Patel",
            therapy: "Abhyanga",
            date: "2025-06-10",
            rating: 5,
            comment:
              "Dr. Patel is very knowledgeable. The Abhyanga therapy was very rejuvenating. I felt a significant reduction in my Vata imbalance symptoms.",
          },
          {
            patientId: "P-003",
            practitionerName: "Dr. Priya Nair",
            therapy: "Virechana",
            date: "2025-04-22",
            rating: 4,
            comment:
              "The Virechana treatment helped with my skin allergies. Dr. Nair provided a very detailed diet plan which was very helpful. The process itself was a bit challenging but worth it.",
          },
          {
            patientId: "P-005",
            practitionerName: "Dr. Meera Gupta",
            therapy: "Nasya",
            date: "2025-07-18",
            rating: 5,
            comment:
              "My migraines have significantly reduced after the Nasya therapy. Dr. Gupta was very gentle and caring throughout the session. Highly recommended.",
          },
          {
            patientId: "P-002",
            practitionerName: "Dr. Amit Desai",
            therapy: "Kati Basti",
            date: "2025-08-20",
            rating: 5,
            comment:
              "The Kati Basti therapy was incredibly effective for my back pain. Dr. Desai was very professional and explained the process clearly. Feeling much better now.",
          },
          {
            patientId: "P-004",
            practitionerName: "Dr. Meera Gupta",
            therapy: "Shirodhara",
            date: "2025-08-10",
            rating: 4,
            comment:
              "Very relaxing session. It helped with my stress levels, but the effects didn't last as long as I had hoped. The clinic environment was very peaceful.",
          },
        ],
        patients: [
          {
            id: "P-001",
            name: "Ananya Roy",
            age: 29,
            gender: "Female",
            contact: "+91 98765 43210",
            conditions: ["Vata imbalance", "Insomnia"],
            wellness: [65, 68, 70, 72, 74],
            wellnessMetrics: {
              weight: { value: "58 kg", change: "-2 kg" },
              agingIndex: { value: "0.85", change: "+0.02" },
            },
            appointments: [],
            // NEW: Documents data for patient
            documents: [
                { id: 'DOC-01', name: 'Blood Report - Aug 2025.pdf', date: '2025-08-20', type: 'pdf' },
                { id: 'DOC-02', name: 'Previous Prescription.jpg', date: '2025-07-15', type: 'img' },
            ],
            currentTherapies: [
              {
                name: "Shirodhara Routine",
                totalDays: 7,
                daysCompleted: 4,
                practitioner: "Dr. Meera Gupta",
              },
              {
                name: "Herbal Supplements",
                totalDays: 30,
                daysCompleted: 12,
                practitioner: "Dr. Suresh Patel",
              },
            ],
            history: [
              {
                date: "2025-08-15",
                therapy: "Shirodhara",
                practitioner: "Dr. Meera Gupta",
                prescription:
                  "Shirodhara with Brahmi oil for 7 days to calm the nervous system.",
              },
              {
                date: "2025-06-10",
                therapy: "Abhyanga",
                practitioner: "Dr. Suresh Patel",
                prescription:
                  "Abhyanga prescription: Apply warm sesame oil daily. Take rest. Next follow-up in 2 weeks.",
              },
              {
                date: "2025-07-05",
                therapy: "Nasya",
                practitioner: "Dr. Priya Nair",
                prescription:
                  "Nasya prescription: Use medicated oil 2 drops each nostril for 7 days.",
              },
            ],
          },
          {
            id: "P-002",
            name: "Rohit Sharma",
            age: 45,
            gender: "Male",
            contact: "+91 91234 56789",
            conditions: ["Ama", "Chronic Back Pain"],
            wellness: [50, 52, 55, 60, 58],
            appointments: [],
            documents: [],
            history: [
              {
                date: "2025-08-20",
                therapy: "Kati Basti",
                practitioner: "Dr. Amit Desai",
                prescription:
                  "Kati Basti with Dhanwantaram oil to relieve back pain. Avoid heavy lifting.",
              },
              {
                date: "2025-05-12",
                therapy: "Basti",
                practitioner: "Dr. Amit Desai",
                prescription:
                  "Basti prescription: Medicated decoction as advised. Avoid heavy food.",
              },
            ],
          },
          {
            id: "P-003",
            name: "Maya Sen",
            age: 34,
            gender: "Female",
            contact: "+91 99887 77665",
            conditions: ["Skin Allergy", "Pitta Imbalance"],
            wellness: [80, 78, 82, 85, 87],
            appointments: [],
            documents: [],
            history: [
              {
                date: "2025-09-01",
                therapy: "Abhyanga",
                practitioner: "Dr. Priya Nair",
                prescription:
                  "Abhyanga with cooling coconut oil to pacify Pitta and soothe the skin.",
              },
              {
                date: "2025-04-22",
                therapy: "Virechana",
                practitioner: "Dr. Priya Nair",
                prescription:
                  "Virechana prescription: Detox regimen and follow low-pitta diet.",
              },
            ],
          },
          {
            id: "P-004",
            name: "Vikram Singh",
            age: 52,
            gender: "Male",
            contact: "+91 98765 11122",
            conditions: ["Hypertension", "Stress"],
            wellness: [60, 58, 62, 65, 63],
            appointments: [],
            documents: [],
            history: [
              {
                date: "2025-08-10",
                therapy: "Shirodhara",
                practitioner: "Dr. Meera Gupta",
                prescription:
                  "Continuous Shirodhara sessions recommended to manage stress and blood pressure.",
              },
            ],
          },
          {
            id: "P-005",
            name: "Priya Devi",
            age: 38,
            gender: "Female",
            contact: "+91 99887 22233",
            conditions: ["Migraine", "Digestive Issues"],
            wellness: [70, 72, 75, 78, 82],
            appointments: [],
            documents: [],
            history: [
              {
                date: "2025-07-18",
                therapy: "Nasya",
                practitioner: "Dr. Meera Gupta",
                prescription:
                  "Nasya therapy to alleviate migraine symptoms. Follow a light diet.",
              },
            ],
          },
        ],
        practitioners: [
          {
            id: "D-01",
            name: "Dr. Suresh Patel",
            specialty: "Vamana, Detox",
            exp: 12,
            rating: 4.8,
            slots: ["2025-09-21T09:00", "2025-09-21T11:00", "2025-09-21T15:00"],
            location: "AyurSutra Clinic, Patia, Bhubaneswar",
          },
          {
            id: "D-02",
            name: "Dr. Priya Nair",
            specialty: "Virechana, Skin disorders",
            exp: 9,
            rating: 4.6,
            slots: ["2025-09-21T10:00", "2025-09-22T11:00"],
            location: "AyurSutra Clinic, Saheed Nagar, Bhubaneswar",
          },
          {
            id: "D-03",
            name: "Dr. Amit Desai",
            specialty: "Basti, Musculoskeletal",
            exp: 15,
            rating: 4.9,
            slots: ["2025-09-21T14:00", "2025-09-22T16:00"],
            location: "AyurSutra Clinic, Khandagiri, Bhubaneswar",
          },
          {
            id: "D-04",
            name: "Dr. Meera Gupta",
            specialty: "Nasya, Stress Management",
            exp: 10,
            rating: 4.7,
            slots: ["2025-09-22T10:00", "2025-09-22T12:00", "2025-09-23T14:00"],
            location: "AyurSutra Wellness Center, Jaydev Vihar, Bhubaneswar",
          },
          {
            id: "D-05",
            name: "Dr. Arjun Varma",
            specialty: "Joint Care, Arthritis",
            exp: 18,
            rating: 4.9,
            slots: ["2025-09-23T09:00", "2025-09-23T11:30"],
            location: "AyurSutra Clinic, Patia, Bhubaneswar",
          },
          {
            id: "D-06",
            name: "Dr. Sunita Kashyap",
            specialty: "Digestive Health, Acidity",
            exp: 7,
            rating: 4.5,
            slots: ["2025-09-22T15:00", "2025-09-23T16:00"],
            location: "AyurSutra Wellness Center, Rasulgarh, Bhubaneswar",
          },
        ],
        clinics: [
          {
            id: "C-01",
            name: "AyurCare Clinic",
            address: "123 Wellness Lane, Patia",
            pincode: "751024",
            distance: "2.5 km",
            rating: 4.7,
          },
          {
            id: "C-02",
            name: "Sattva Ayurveda",
            address: "45 Health Street, Saheed Nagar",
            pincode: "751007",
            distance: "5.1 km",
            rating: 4.9,
          },
          {
            id: "C-03",
            name: "Prakriti Wellness Center",
            address: "78 Nature's Way, Khandagiri",
            pincode: "751030",
            distance: "8.2 km",
            rating: 4.6,
          },
          {
            id: "C-04",
            name: "Dosha Balance Clinic",
            address: "90 Harmony Road, Jaydev Vihar",
            pincode: "751013",
            distance: "7.8 km",
            rating: 4.8,
          },
        ],
        appointments: [
          {
            id: "A-100",
            patientId: "P-005",
            doctorId: "D-01",
            datetime: "2025-09-21T15:00",
            therapy: "Vamana Consult",
            status: "Scheduled",
            mode: "Physical",
          },
          {
            id: "A-101",
            patientId: "P-002",
            doctorId: "D-03",
            datetime: "2025-09-19T14:00",
            therapy: "Kati Basti Follow-up",
            status: "Scheduled",
            mode: "Physical",
          },
          {
            id: "A-102",
            patientId: "P-004",
            doctorId: "D-04",
            datetime: "2025-09-22T10:00",
            therapy: "Stress Management",
            status: "Scheduled",
            mode: "Online",
          },
          {
            id: "A-103",
            patientId: "P-003",
            doctorId: "D-02",
            datetime: "2025-09-19T10:00",
            therapy: "Skin Follow-up",
            status: "Completed",
            mode: "Online",
          },
          {
            id: "A-104",
            patientId: "P-001",
            doctorId: "D-01",
            datetime: "2025-09-25T11:00",
            therapy: "Detox Consult",
            status: "Scheduled",
            mode: "Physical",
          },
          {
            id: "A-105",
            patientId: "P-003",
            doctorId: "D-02",
            datetime: "2025-09-22T11:00",
            therapy: "Virechana Follow-up",
            status: "Scheduled",
            mode: "Online",
          },
          {
            id: "A-106",
            patientId: "P-002",
            doctorId: "D-03",
            datetime: "2025-09-29T16:00",
            therapy: "Pain Management",
            status: "Scheduled",
            mode: "Physical",
          },
        ],
      };

      const translations = {
        en: {
          // Login
          welcome: "Welcome to AyurSutra",
          subtitle: "Your journey to holistic wellness starts here.",
          patientLogin: "Patient Login",
          practitionerLogin: "Practitioner Login",
          // General
          dashboard: "Dashboard",
          logout: "Logout",
          history: "History",
          edit: "Edit",
          close: "Close",
          details: "Details",
          schedule: "Schedule",
          searching: "Searching…",
          learn: "Learn",
          // Patient Dashboard
          patientDashboardTitle: "Patient Dashboard",
          age: "Age",
          gender: "Gender",
          contact: "Contact",
          nextAppointment: "Next Appointment",
          conditions: "Conditions",
          assistantTitle: "AyurSutra Assistant",
          issuePlaceholder:
            "e.g., 'I have been experiencing frequent headaches and shoulder stiffness.'",
          findSpecialist: "Find a Specialist",
          findClinics: "Clinics Around Me",
          enterPincode: "Enter your 6-digit pincode",
          search: "Search",
          clinicsNearYou: "Clinics Near You",
          noClinicsFound:
            "No clinics found for this pincode. Try a nearby one.",
          currentTherapies: "Current Therapies",
          noActiveTherapies: "No active therapies.",
          upcomingSessions: "Upcoming Sessions",
          wellnessProgress: "Wellness Progress",
          therapies: "Therapies",
          noUpcomingSessions: "No upcoming sessions",
          noSessionsMessage: "You have no scheduled sessions.",
          suggestionsFound: "suggestion(s) found.",
          describeIssue: "Please describe your issue before sending.",
          upcomingSessionCount: "{count} upcoming session(s)",
          appointmentDetails: "Appointment Details",
          scheduleWith: "Schedule with {name}",
          selectSlot: "1. Select an available time slot:",
          selectMode: "2. Select consultation mode:",
          confirmPhysical: "Confirm Physical",
          confirmOnline: "Confirm Online",
          appointmentScheduled: "Appointment scheduled successfully!",
          noHistory: "No past therapies recorded.",
          downloadStarted: "Prescription download started.",
          giveFeedback: "Give Feedback",
          feedbackSent: "Feedback Sent",
          submitFeedback: "Submit Feedback",
          giveFeedbackFor: "Give Feedback for",
          yourRating: "Your Rating",
          yourComments: "Your Comments",
          feedbackPlaceholder: "Share details of your experience...",
          feedbackSubmitted: "Thank you for your feedback!",
          educationHub: "Ayurveda Knowledge Hub",

          // Practitioner Dashboard
          practitionerDashboardTitle: "Practitioner Dashboard",
          patients: "Patients",
          searchPatientsPlaceholder: "Search patients...",
          todaysAppointments: "Today's Appointments",
          patientDetails: "Patient Details",
          noAppointments: "No appointments scheduled for this day.",
          selectedAppointment: "Selected Appointment",
          markCompleted: "Mark Completed",
          addNote: "Add Note",
          markedCompleted: "Marked completed",
          recentFeedback: "Recent Feedback",
        },
        hi: {
          // Login
          welcome: "आयुसूत्र में आपका स्वागत है",
          subtitle: "समग्र कल्याण की ओर आपकी यात्रा यहां से शुरू होती है।",
          patientLogin: "रोगी लॉगिन",
          practitionerLogin: "चिकित्सक लॉगिन",
          // General
          dashboard: "डैशबोर्ड",
          logout: "लॉग आउट",
          history: "इतिहास",
          edit: "संपादित करें",
          close: "बंद करें",
          details: "विवरण",
          schedule: "अनुसूची",
          searching: "खोज रहा है…",
          learn: "सीखें",
          // Patient Dashboard
          patientDashboardTitle: "रोगी डैशबोर्ड",
          age: "आयु",
          gender: "लिंग",
          contact: "संपर्क",
          nextAppointment: "अगली नियुक्ति",
          conditions: "स्थितियाँ",
          assistantTitle: "आयुसूत्र सहायक",
          issuePlaceholder:
            "उदा., 'मुझे बार-बार सिरदर्द और कंधे में अकड़न हो रही है।'",
          findSpecialist: "एक विशेषज्ञ खोजें",
          findClinics: "मेरे आस-पास के क्लिनिक",
          enterPincode: "अपना 6 अंकों का पिनकोड दर्ज करें",
          search: "खोज",
          clinicsNearYou: "आपके आस-पास के क्लिनिक",
          noClinicsFound:
            "इस पिनकोड के लिए कोई क्लिनिक नहीं मिला। पास का कोई प्रयास करें।",
          currentTherapies: "वर्तमान चिकित्साएं",
          noActiveTherapies: "कोई सक्रिय चिकित्सा नहीं।",
          upcomingSessions: "आगामी सत्र",
          wellnessProgress: "कल्याण प्रगति",
          therapies: "चिकित्साएं",
          noUpcomingSessions: "कोई आगामी सत्र नहीं",
          noSessionsMessage: "आपके पास कोई निर्धारित सत्र नहीं है।",
          suggestionsFound: "सुझाव मिले।",
          describeIssue: "कृपया भेजने से पहले अपनी समस्या का वर्णन करें।",
          upcomingSessionCount: "{count} आगामी सत्र",
          appointmentDetails: "नियुक्ति विवरण",
          scheduleWith: "{name} के साथ शेड्यूल करें",
          selectSlot: "1. एक उपलब्ध समय स्लॉट चुनें:",
          selectMode: "2. परामर्श मोड चुनें:",
          confirmPhysical: "भौतिक पुष्टि करें",
          confirmOnline: "ऑनलाइन पुष्टि करें",
          appointmentScheduled: "नियुक्ति सफलतापूर्वक निर्धारित हो गई!",
          noHistory: "कोई पिछला उपचार दर्ज नहीं किया गया।",
          downloadStarted: "प्रिस्क्रिप्शन डाउनलोड शुरू हो गया।",
          giveFeedback: "प्रतिक्रिया दें",
          feedbackSent: "प्रतिक्रिया भेजी गई",
          submitFeedback: "प्रतिक्रिया सबमिट करें",
          giveFeedbackFor: "के लिए प्रतिक्रिया दें",
          yourRating: "आपकी रेटिंग",
          yourComments: "आपकी टिप्पणियाँ",
          feedbackPlaceholder: "अपने अनुभव का विवरण साझा करें...",
          feedbackSubmitted: "आपकी प्रतिक्रिया के लिए धन्यवाद!",
          educationHub: "आयुर्वेद ज्ञान केंद्र",
          // Practitioner Dashboard
          practitionerDashboardTitle: "चिकित्सक डैशबोर्ड",
          patients: "मरीजों",
          searchPatientsPlaceholder: "मरीजों को खोजें...",
          todaysAppointments: "आज की नियुक्तियाँ",
          patientDetails: "रोगी विवरण",
          noAppointments: "इस दिन के लिए कोई नियुक्ति निर्धारित नहीं है।",
          selectedAppointment: "चयनित नियुक्ति",
          markCompleted: "पूर्ण के रूप में चिह्नित करें",
          addNote: "नोट जोड़ें",
          markedCompleted: "पूर्ण के रूप में चिह्नित किया गया",
          recentFeedback: "हाल की प्रतिक्रिया",
        },
        bn: {
          // Login
          welcome: "AyurSutra-এ স্বাগতম",
          subtitle: "আপনার সামগ্রিক সুস্থতার যাত্রা শুরু হচ্ছে এখান থেকে।",
          patientLogin: "রোগী লগইন",
          practitionerLogin: "চিকিৎসক লগইন",
          // General
          dashboard: "ড্যাশবোর্ড",
          logout: "লগআউট",
          history: "ইতিহাস",
          edit: "সম্পাদনা",
          close: "বন্ধ করুন",
          details: "বিস্তারিত",
          schedule: "নির্ধারণ করুন",
          searching: "অনুসন্ধান চলছে…",
          learn: "শিখুন",
          // Patient Dashboard
          patientDashboardTitle: "রোগী ড্যাশবোর্ড",
          age: "বয়স",
          gender: "লিঙ্গ",
          contact: "যোগাযোগ",
          nextAppointment: "পরবর্তী অ্যাপয়েন্টমেন্ট",
          conditions: "অবস্থা",
          assistantTitle: "AyurSutra সহকারী",
          issuePlaceholder:
            "যেমন, 'আমি ঘন ঘন মাথাব্যথা এবং কাঁধে শক্তভাব অনুভব করছি।'",
          findSpecialist: "বিশেষজ্ঞ খুঁজুন",
          findClinics: "আমার কাছাকাছি ক্লিনিক",
          enterPincode: "আপনার ৬-সংখ্যার পিনকোড লিখুন",
          search: "অনুসন্ধান",
          clinicsNearYou: "আপনার কাছাকাছি ক্লিনিক",
          noClinicsFound:
            "এই পিনকোডের জন্য কোনো ক্লিনিক পাওয়া যায়নি। কাছাকাছি একটি চেষ্টা করুন।",
          currentTherapies: "বর্তমান থেরাপি",
          noActiveTherapies: "কোনো সক্রিয় থেরাপি নেই।",
          upcomingSessions: "আসন্ন সেশন",
          wellnessProgress: "সুস্থতার অগ্রগতি",
          therapies: "থেরাপি",
          noUpcomingSessions: "কোনও আসন্ন সেশন নেই",
          noSessionsMessage: "আপনার কোনো নির্ধারিত সেশন নেই।",
          suggestionsFound: "সুপারিশ পাওয়া গেছে।",
          describeIssue: "প্রেরণের আগে দয়া করে আপনার সমস্যা বর্ণনা করুন।",
          upcomingSessionCount: "{count}টি আসন্ন সেশন",
          appointmentDetails: "অ্যাপয়েন্টমেন্টের বিবরণ",
          scheduleWith: "{name}-এর সাথে অ্যাপয়েন্টমেন্ট করুন",
          selectSlot: "১. একটি উপলব্ধ সময় স্লট নির্বাচন করুন:",
          selectMode: "২. পরামর্শ মোড নির্বাচন করুন:",
          confirmPhysical: "উপস্থিতির জন্য নিশ্চিত করুন",
          confirmOnline: "অনলাইন নিশ্চিত করুন",
          appointmentScheduled: "অ্যাপয়েন্টমেন্ট সফলভাবে নির্ধারিত হয়েছে!",
          noHistory: "কোনো পূর্ববর্তী থেরাপির রেকর্ড নেই।",
          downloadStarted: "প্রেসক্রিপসন ডাউনলোড শুরু হয়েছে।",
          giveFeedback: "মতামত দিন",
          feedbackSent: "মতামত পাঠানো হয়েছে",
          submitFeedback: "মতামত জমা দিন",
          giveFeedbackFor: "-এর জন্য মতামত দিন",
          yourRating: "আপনার রেটিং",
          yourComments: "আপনার মন্তব্য",
          feedbackPlaceholder: "আপনার অভিজ্ঞতার বিবরণ শেয়ার করুন...",
          feedbackSubmitted: "আপনার মতামতের জন্য ধন্যবাদ!",
          educationHub: "আয়ুর্বেদ জ্ঞান কেন্দ্র",
          // Practitioner Dashboard
          practitionerDashboardTitle: "চিকিৎসক ড্যাশবোর্ড",
          patients: "রোগী",
          searchPatientsPlaceholder: "মरीजি খুঁজুন...",
          todaysAppointments: "আজকের অ্যাপয়েন্টমেন্ট",
          patientDetails: "রোগীর বিস্তারিত",
          noAppointments: "এই দিনে কোনো অ্যাপয়েন্টমেন্ট নির্ধারিত নেই।",
          selectedAppointment: "নির্বাচিত অ্যাপয়েন্টমেন্ট",
          markCompleted: "সম্পন্ন হিসাবে চিহ্নিত করুন",
          addNote: "নোট যোগ করুন",
          markedCompleted: "সম্পন্ন হিসাবে চিহ্নিত করা হয়েছে",
          recentFeedback: "সাম্প্রতিক মতামত",
        },
        or: {
          // Login
          welcome: "ଆୟୁସୂତ୍ରକୁ ସ୍ଵାଗତ",
          subtitle: "ସାମଗ୍ରିକ ସୁସ୍ଥତା ପାଇଁ ଆପଣଙ୍କ ଯାତ୍ରା ଏଠାରୁ ଆରମ୍ଭ ହୁଏ।",
          patientLogin: "ରୋଗୀ ଲଗଇନ୍",
          practitionerLogin: "ଚିକିତ୍ସକ ଲଗଇନ୍",
          // General
          dashboard: "ଡ୍ୟାସବୋର୍ଡ",
          logout: "ଲଗଆଉଟ୍",
          history: "ଇତିହାସ",
          edit: "ସମ୍ପାଦନ କରନ୍ତୁ",
          close: "ବନ୍ଦ କରନ୍ତୁ",
          details: "ବିବରଣୀ",
          schedule: "ସମୟ-ସାରଣୀ",
          searching: "ଖୋଜା ଚାଲିଛି...",
          learn: "ଶିଖନ୍ତୁ",
          // Patient Dashboard
          patientDashboardTitle: "ରୋଗୀ ଡ୍ୟାସବୋର୍ଡ",
          age: "ବୟସ",
          gender: "ଲିଙ୍ଗ",
          contact: "ସମ୍ପର୍କ",
          nextAppointment: "ପରବର୍ତ୍ତୀ ଆପଏଣ୍ଟମେଣ୍ଟ",
          conditions: "ଅବସ୍ଥା",
          assistantTitle: "ଆୟୁସୂତ୍ର ସହାୟକ",
          issuePlaceholder:
            "ଉଦାହରଣ, 'ମୋର ବାରମ୍ବାର ମୁଣ୍ଡବିନ୍ଧା ଏବଂ କାନ୍ଧରେ କଠିନତା ଅନୁଭବ ହେଉଛି।'",
          findSpecialist: "ଏକ ବିଶେଷଜ୍ଞ ଖୋଜନ୍ତୁ",
          findClinics: "ମୋ ଆଖପାଖର କ୍ଲିନିକ୍",
          enterPincode: "ଆପଣଙ୍କ ୬-ଅଙ୍କ ବିଶିଷ୍ଟ ପିନକୋଡ୍ ଦିଅନ୍ତୁ",
          search: "ଖୋଜନ୍ତୁ",
          clinicsNearYou: "ଆପଣଙ୍କ ନିକଟରେ ଥିବା କ୍ଲିନିକ୍",
          noClinicsFound:
            "ଏହି ପିନକୋଡ୍ ପାଇଁ କୌଣସି କ୍ଲିନିକ୍ ମିଳିଲା ନାହିଁ। ନିକଟବର୍ତ୍ତୀ ସ୍ଥାନ ଚେଷ୍ଟା କରନ୍ତୁ।",
          currentTherapies: "ବର୍ତ୍ତମାନର ଚିକିତ୍ସା",
          noActiveTherapies: "କୌଣସି ସକ୍ରିୟ ଚିକିତ୍ସା ନାହିଁ।",
          upcomingSessions: "ଆଗାମୀ ସେସନ୍",
          wellnessProgress: "ସ୍ୱାସ୍ଥ୍ୟ ପ୍ରଗତି",
          therapies: "ଚିକିତ୍ସା",
          noUpcomingSessions: "କୋଣସି ଆଗାମୀ ସେସନ୍ ନାହିଁ",
          noSessionsMessage: "ଆପଣଙ୍କର କୋଣସି ନିର୍ଧାରିତ ସେସନ୍ ନାହିଁ।",
          suggestionsFound: "ପରାମର୍ଶ ମିଳିଲା।",
          describeIssue: "ଦୟାକରି ପଠାଇବା ପୂର୍ବରୁ ଆପଣଙ୍କ ସମସ୍ୟା ବର୍ଣ୍ଣନା କରନ୍ତୁ।",
          upcomingSessionCount: "{count} ଆଗାମୀ ସେସନ୍",
          appointmentDetails: "ଆପଏଣ୍ଟମେଣ୍ଟ ବିବରଣୀ",
          scheduleWith: "{name} ଙ୍କ ସହିତ ସମୟ-ସାରଣୀ",
          selectSlot: "୧. ଏକ ଉପଲବ୍ଧ ସମୟ ସ୍ଲଟ୍ ବାଛନ୍ତୁ:",
          selectMode: "୨. ପରାମର୍ଶ ମୋଡ୍ ବାଛନ୍ତୁ:",
          confirmPhysical: "ଶାରୀରିକ ଉପସ୍ଥିତି ନିଶ୍ଚିତ କରନ୍ତୁ",
          confirmOnline: "ଅନଲାଇନ୍ ନିଶ୍ଚିତ କରନ୍ତୁ",
          appointmentScheduled: "ଆପଏଣ୍ଟମେଣ୍ଟ ସଫଳତାର ସହିତ ନିର୍ଧାରିତ ହୋଇଛି!",
          noHistory: "କୌଣସି ପୂର୍ବ ଚିକିତ୍ସା ରେକର୍ଡ ହୋଇନାହିଁ।",
          downloadStarted: "ପ୍ରେସକ୍ରିପସନ୍ ଡାଉନଲୋଡ୍ ଆରମ୍ଭ ହୋଇଛି।",
          giveFeedback: "ମତାମତ ଦିଅନ୍ତୁ",
          feedbackSent: "ମତାମତ ପଠାଯାଇଛି",
          submitFeedback: "ମତାମତ ଦାଖଲ କରନ୍ତୁ",
          giveFeedbackFor: "ପାଇଁ ମତାମତ ଦିଅନ୍ତୁ",
          yourRating: "ଆପଣଙ୍କ ରେଟିଂ",
          yourComments: "ଆପଣଙ୍କ ମନ୍ତବ୍ୟ",
          feedbackPlaceholder: "ଆପଣଙ୍କ ଅନୁଭୂତିର ବିବରଣୀ ଦିଅନ୍ତୁ...",
          feedbackSubmitted: "ଆପଣଙ୍କ ମତାମତ ପାଇଁ ଧନ୍ୟବାଦ!",
          educationHub: "ଆୟୁର୍ବେଦ ଜ୍ଞାନ କେନ୍ଦ୍ର",
          // Practitioner Dashboard
          practitionerDashboardTitle: "ଚିକିତ୍ସକ ଡ୍ୟାସବୋର୍ଡ",
          patients: "ମरीज",
          searchPatientsPlaceholder: "ମरीज ଖୋଜନ୍ତୁ...",
          todaysAppointments: "ଆଜିର ଆପଏଣ୍ଟମେଣ୍ଟ",
          patientDetails: "ରୋଗୀ ବିବରଣୀ",
          noAppointments: "ଏହି ଦିନ ପାଇଁ କୌଣସି ଆପଏଣ୍ଟମେଣ୍ଟ ନିର୍ଧାରିତ ହୋଇନାହିଁ।",
          selectedAppointment: "ଚୟନିତ ଆପଏଣ୍ଟମେଣ୍ଟ",
          markCompleted: "ସମ୍ପୂର୍ଣ୍ଣ ଭାବରେ ଚିହ୍ନିତ କରନ୍ତୁ",
          addNote: "ନୋଟ୍ ଯୋଗ କରନ୍ତୁ",
          markedCompleted: "ସମ୍ପୂର୍ଣ୍ଣ ଭାବରେ ଚିହ୍ନିତ ହୋଇଛି",
          recentFeedback: "ନିକଟବର୍ତ୍ତୀ ମତାମତ",
        },
      };

      state.appointments.forEach((a) => {
        const p = state.patients.find((x) => x.id === a.patientId);
        if (p) p.appointments.push(a);
      });
      function $(sel) {
        return document.querySelector(sel);
      }
      function $all(sel) {
        return Array.from(document.querySelectorAll(sel));
      }
      function formatDate(dt) {
        const d = new Date(dt);
        return d.toLocaleString("en-IN", {
          dateStyle: "medium",
          timeStyle: "short",
        });
      }
      function timeSince(date) {
          // FIX: Use the mocked current date from the state for consistent time calculation
          const now = state.currentCalendarDate; 
          const seconds = Math.floor((now - new Date(date)) / 1000);
          
          if (seconds < 0) {
            // As requested, handle future events to avoid negative numbers.
            return "Upcoming";
          }

          if (seconds < 10) return "just now";
          if (seconds < 60) return `${Math.floor(seconds)} seconds ago`;

          const minutes = Math.floor(seconds / 60);
          if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;

          const hours = Math.floor(minutes / 60);
          if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
          
          const days = Math.floor(hours / 24);
          return `${days} day${days > 1 ? 's' : ''} ago`;
      }
      function toast(msg, ttl = 3000) {
        const t = document.createElement("div");
        t.className =
          "px-6 py-3 bg-primary dark:bg-d-primary text-white rounded-full shadow-lg mb-2";
        t.textContent = msg;
        $("#toast").appendChild(t);
        gsap.from(t, { opacity: 0, y: 20, duration: 0.4, ease: "power2.out" });
        setTimeout(() => {
          gsap.to(t, {
            opacity: 0,
            y: 20,
            duration: 0.4,
            ease: "power2.in",
            onComplete: () => t.remove(),
          });
        }, ttl);
      }

      function mockLLMQuery(issue) {
        return new Promise((res) => {
          const latency = 600 + Math.random() * 400;
          setTimeout(() => {
            const lowercasedIssue = issue.toLowerCase();
            const keywordMap = {
              headache: ["Nasya, Stress Management"],
              migraine: ["Nasya, Stress Management"],
              stress: ["Nasya, Stress Management"],
              insomnia: ["Nasya, Stress Management"],
              skin: ["Virechana, Skin disorders"],
              allergy: ["Virechana, Skin disorders"],
              pitta: ["Virechana, Skin disorders"],
              joint: ["Basti, Musculoskeletal", "Joint Care, Arthritis"],
              pain: ["Basti, Musculoskeletal", "Joint Care, Arthritis"],
              back: ["Basti, Musculoskeletal"],
              arthritis: ["Joint Care, Arthritis"],
              stomach: ["Digestive Health, Acidity"],
              digestive: ["Digestive Health, Acidity"],
              acidity: ["Digestive Health, Acidity"],
              detox: ["Vamana, Detox"],
              ama: ["Vamana, Detox"],
              kapha: ["Vamana, Detox"],
            };
            const matchedSpecialties = new Set();
            for (const keyword in keywordMap) {
              if (lowercasedIssue.includes(keyword)) {
                keywordMap[keyword].forEach((spec) =>
                  matchedSpecialties.add(spec)
                );
              }
            }
            let matches = [];
            if (matchedSpecialties.size > 0) {
              matches = state.practitioners.filter((doc) =>
                matchedSpecialties.has(doc.specialty)
              );
            }
            if (matches.length === 0) {
              const issueWords = new Set(
                lowercasedIssue.split(/\s+/).filter((word) => word.length > 3)
              );
              matches = state.practitioners.filter((doc) => {
                const specialtyWords = new Set(
                  doc.specialty.toLowerCase().split(/[\s,]+/)
                );
                return [...issueWords].some((word) => specialtyWords.has(word));
              });
            }
            if (matches.length === 0) {
              matches = state.practitioners
                .slice()
                .sort((a, b) => b.rating - a.rating);
            }
            const out = matches.slice(0, 3).map((d) => ({
              id: d.id,
              name: d.name,
              specialty: d.specialty,
              exp: d.exp,
              rating: d.rating,
              reason: `Suggested for expertise in ${d.specialty}`,
              slots: d.slots,
            }));
            res(out);
          }, latency);
        });
      }

      function t(key) {
        const lang = state.currentLanguage;
        if (translations[lang] && translations[lang][key]) {
          return translations[lang][key];
        }
        return translations["en"][key] || key; // Fallback to English
      }

      function applyTranslations() {
        document.querySelectorAll("[data-translate]").forEach((el) => {
          const key = el.dataset.translate;
          el.textContent = t(key);
        });
        document
          .querySelectorAll("[data-translate-placeholder]")
          .forEach((el) => {
            const key = el.dataset.translatePlaceholder;
            el.placeholder = t(key);
          });

        // Specific element updates that are not covered by data-attributes
        if (!$("#app-shell").classList.contains("hidden")) {
          if (state.currentUser?.type === "patient") {
            $("#app-title").textContent = t("patientDashboardTitle");
            renderUpcomingSession(state.currentUser.id);
          } else if (state.currentUser?.type === "practitioner") {
            $("#app-title").textContent = t("practitionerDashboardTitle");
            renderCalendar(state.currentUser.id, state.currentCalendarDate);
          }
        }
      }

      function changeLanguage(lang) {
        state.currentLanguage = lang;

        // Update login screen text
        const subtitleEl = $("#screen-login p");
        if (subtitleEl) {
          subtitleEl.textContent = t("subtitle");
        }
        const patientLoginBtn = $("#btn-patient-login");
        if (patientLoginBtn) {
          patientLoginBtn.textContent = t("patientLogin");
        }
        const practitionerLoginBtn = $("#btn-practitioner-login");
        if (practitionerLoginBtn) {
          practitionerLoginBtn.textContent = t("practitionerLogin");
        }

        document.querySelectorAll(".lang-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.lang === lang);
        });

        // Apply translations to the rest of the app
        applyTranslations();
      }

      let wellnessChart = null;
      function init() {
        $("#btn-patient-login")?.addEventListener("click", () => loginAs("patient", "P-001"));
        $("#btn-practitioner-login")?.addEventListener("click", () => loginAs("practitioner", "D-01"));
        $("#btn-logout")?.addEventListener("click", () => logout());
        $("#btn-send-llm")?.addEventListener("click", () => handleSendLLM());
        $("#history-btn")?.addEventListener("click", () => openHistoryModal(state.currentUser.id));
        $("#pract-search-go")?.addEventListener("click", () => handlePractSearch());
        $("#pract-close-slide")?.addEventListener("click", () => hidePractSlide());
        $("#btn-find-clinics")?.addEventListener("click", openClinicsModal);
        $("#btn-learn")?.addEventListener("click", openEducationModal);
        $("#cal-prev").addEventListener("click", () => {
          state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth() - 1);
          renderCalendar(state.currentUser.id, state.currentCalendarDate);
        });
        $("#cal-next").addEventListener("click", () => {
          state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth() + 1);
          renderCalendar(state.currentUser.id, state.currentCalendarDate);
        });
        $all(".lang-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => changeLanguage(e.currentTarget.dataset.lang));
        });

        // NEW: Event listeners for new features
        $("#btn-notifications")?.addEventListener("click", toggleNotificationPopover);
        $("#btn-messages")?.addEventListener("click", () => openChatModal());
        $("#doc-upload-input")?.addEventListener("change", handleDocumentUpload);

        setupTheme();

        gsap.from("#screen-login", { y: 20, opacity: 0, duration: 0.5, ease: "power2.out" });
        renderTherapies();
        changeLanguage(state.currentLanguage); // Set initial language
      }

      function setupTheme() {
        const themeToggleBtn = $("#theme-toggle");
        const themeToggleDarkIcon = $("#theme-toggle-dark-icon");
        const themeToggleLightIcon = $("#theme-toggle-light-icon");

        const setTheme = (theme) => {
          if (theme === "dark") {
            document.documentElement.classList.add("dark");
            themeToggleLightIcon.classList.remove("hidden");
            themeToggleDarkIcon.classList.add("hidden");
          } else {
            document.documentElement.classList.remove("dark");
            themeToggleDarkIcon.classList.remove("hidden");
            themeToggleLightIcon.classList.add("hidden");
          }
          if (
            state.currentUser?.type === "patient" &&
            $("#wellnessChart")?.offsetParent !== null
          ) {
            renderWellnessChart(state.currentUser.id);
          }
        };

        themeToggleBtn.addEventListener("click", () => {
          const isDark = document.documentElement.classList.contains("dark");
          setTheme(isDark ? "light" : "dark");
        });

        // Initialize theme
        setTheme("light"); // Default to light
      }

      function loginAs(type, id) {
        document.body.classList.remove("login-active");
        state.currentUser = { type, id };
        
        // NEW: Populate notifications on login
        populateNotifications(id);

        gsap.to("#screen-login", {
          opacity: 0,
          duration: 0.3,
          onComplete: () => {
            $("#screen-login")?.classList.add("hidden");
            const shell = $("#app-shell");
            if (shell) {
              shell.removeAttribute("style");
              shell.classList.remove("hidden");
            }
            gsap.from("#app-shell", { opacity: 0, duration: 0.4 });
            const badge = $("#user-badge");
            if (badge)
              badge.textContent =
                type === "patient"
                  ? `Patient: ${id}`
                  : `Practitioner: ${
                      state.practitioners.find((p) => p.id === id).name
                    }`;
            if (type === "patient") showPatientDashboard(id);
            else showPractitionerDashboard(id);
          },
        });
      }
      function logout() {
        gsap.to("#app-shell", {
          opacity: 0,
          duration: 0.3,
          onComplete: () => {
            $("#app-shell")?.classList.add("hidden");
            $("#screen-login")?.classList.remove("hidden");
            $("#screen-login")?.removeAttribute("style");
            gsap.from("#screen-login", { y: 20, opacity: 0, duration: 0.4 });
            $("#dashboard-patient")?.classList.add("hidden");
            $("#dashboard-practitioner")?.classList.add("hidden");
            $("#btn-find-clinics")?.classList.add("hidden");
            $("#btn-learn")?.classList.add("hidden");
            document.body.classList.add("login-active");
            state.currentUser = null;
          },
        });
      }
      function showPatientDashboard(patientId) {
        $("#app-title").textContent = t("patientDashboardTitle");
        $("#dashboard-practitioner")?.classList.add("hidden");
        $("#dashboard-patient")?.classList.remove("hidden");
        populatePatientInfo(patientId);
        renderCurrentTherapies(patientId);
        renderUpcomingSession(patientId);
        renderWellnessChart(patientId);
        renderWellnessMetrics(patientId);
        renderDoctorResults([]);
        // NEW: Render documents
        renderDocuments(patientId);
        $("#btn-find-clinics")?.classList.remove("hidden");
        $("#btn-learn")?.classList.remove("hidden");
        applyTranslations();
        gsap.from("#dashboard-patient .card", {
          y: 20,
          opacity: 0,
          duration: 0.4,
          stagger: 0.08,
        });
      }
      function populatePatientInfo(pid) {
        const p = state.patients.find((x) => x.id === pid);
        if (!p) return;
        $("#patient-name-display").textContent = p.name;
        $("#patient-id-display").textContent = `ID: ${p.id}`;
        $("#patient-age").textContent = p.age;
        $("#patient-gender").textContent = p.gender;
        $("#patient-contact").textContent = p.contact;
        $("#patient-conditions").innerHTML = p.conditions
          .map(
            (c) =>
              `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-accent/20 dark:bg-d-accent/20 dark:text-d-text-primary">${c}</span>`
          )
          .join(" ");
        const next = p.appointments
          .filter((a) => new Date(a.datetime) > new Date("2025-09-19T18:00:00"))
          .sort((a, b) => new Date(a.datetime) - new Date(b.datetime))[0];
        $("#patient-next").textContent = next ? formatDate(next.datetime) : "—";
      }

      function renderCurrentTherapies(pid) {
        const patient = state.patients.find((p) => p.id === pid);
        const container = $("#current-therapies-list");
        if (!container) return;

        if (
          !patient ||
          !patient.currentTherapies ||
          patient.currentTherapies.length === 0
        ) {
          container.innerHTML = `<div class="p-4 rounded-lg border-dashed border-gray-300/80 dark:border-slate-600 text-center text-sm text-text-secondary">${t(
            "noActiveTherapies"
          )}</div>`;
          return;
        }

        container.innerHTML = patient.currentTherapies
          .map((therapy) => {
            const progressPercentage =
              (therapy.daysCompleted / therapy.totalDays) * 100;
            return `
            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="font-semibold text-text-primary">${therapy.name}</span>
                    <span class="text-xs font-medium text-text-secondary">Day ${therapy.daysCompleted} of ${therapy.totalDays}</span>
                </div>
                <div class="w-full bg-gray-200/70 dark:bg-slate-700 rounded-full h-2.5">
                    <div class="bg-primary dark:bg-d-primary h-2.5 rounded-full" style="width: ${progressPercentage}%"></div>
                </div>
                <div class="text-xs text-text-secondary mt-1">with ${therapy.practitioner}</div>
            </div>
        `;
          })
          .join("");
      }

      function renderUpcomingSession(pid) {
        const p = state.patients.find((x) => x.id === pid);
        const upcoming = p.appointments
          .filter((a) => new Date(a.datetime) > new Date("2025-09-19T18:00:00"))
          .sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
        const el = $("#upcoming-session");
        if (!el) return;
        el.innerHTML = "";
        if (upcoming.length > 0) {
          $("#upcoming-session-meta").textContent = t(
            "upcomingSessionCount"
          ).replace("{count}", upcoming.length);
          const sessionsHtml = upcoming
            .map((appt) => {
              const doc = state.practitioners.find(
                (d) => d.id === appt.doctorId
              );
              const modeTag =
                appt.mode === "Online"
                  ? `<span class="text-xs px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900/70 text-blue-800 dark:text-blue-200 font-semibold">Online</span>`
                  : `<span class="text-xs px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/70 text-green-800 dark:text-green-200 font-semibold">Physical</span>`;
              return `<div class="p-4 rounded-xl border border-gray-200/50 dark:border-slate-700 flex items-center justify-between mb-2 bg-white/30 dark:bg-slate-800/30"><div><div class="font-semibold text-text-primary">${
                appt.therapy
              }</div><div class="text-sm text-text-secondary">${formatDate(
                appt.datetime
              )} • ${
                doc ? doc.name : ""
              }</div></div><div class="flex items-center gap-3">${modeTag}<button class="view-session-details px-3 py-1 rounded-md bg-secondary/20 hover:bg-secondary/30 dark:bg-orange-400/20 dark:hover:bg-orange-400/30 text-sm font-semibold" data-appid="${
                appt.id
              }">${t("details")}</button></div></div>`;
            })
            .join("");
          el.innerHTML = sessionsHtml;
          el.querySelectorAll(".view-session-details").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const appId = e.currentTarget.dataset.appid;
              const appt = state.appointments.find((a) => a.id === appId);
              if (appt) openSessionDetailsModal(appt);
            });
          });
        } else {
          $("#upcoming-session-meta").textContent = t("noUpcomingSessions");
          el.innerHTML = `<div class="p-4 rounded-lg border-dashed border-gray-300/80 dark:border-slate-600 text-center text-sm text-text-secondary">${t(
            "noSessionsMessage"
          )}</div>`;
        }
      }

      function openSessionDetailsModal(appt) {
        const doc = state.practitioners.find((d) => d.id === appt.doctorId);
        if (!doc) return;
        let locationInfo =
          appt.mode === "Physical"
            ? `<p class="mt-2 text-sm"><strong>Location:</strong> ${doc.location}</p>`
            : `<p class="mt-2 text-sm"><strong>Meeting Link:</strong> <a href="#" class="text-blue-600 dark:text-blue-400">https://meet.ayursutra.com/session/${appt.id}</a></p>`;
        const modalContent = `<h4 class="font-semibold text-lg">${
          appt.therapy
        } with ${doc.name}</h4><p class="text-sm text-text-secondary">${
          doc.specialty
        }</p><div class="mt-4 p-4 bg-background dark:bg-d-background rounded-lg border border-gray-200/50 dark:border-slate-600"><p class="text-sm"><strong>Date & Time:</strong> ${formatDate(
          appt.datetime
        )}</p><p class="text-sm"><strong>Mode:</strong> ${
          appt.mode
        }</p>${locationInfo}</div>`;
        openInfoModal(t("appointmentDetails"), modalContent);
      }
      function renderWellnessChart(pid) {
        const p = state.patients.find((x) => x.id === pid);
        if (!p) return;

        const isDark = document.documentElement.classList.contains("dark");
        const gridColor = isDark
          ? "rgba(255, 255, 255, 0.1)"
          : "rgba(0, 0, 0, 0.1)";
        const ticksColor = isDark ? "#a0aec0" : "#576c7a";
        const pointColor = isDark ? "#1a202c" : "#FFF";
        const borderColor = isDark ? "#319795" : "#368D8B";
        const bgColor = isDark
          ? "rgba(49, 151, 149, 0.2)"
          : "rgba(54, 141, 139, 0.1)";

        const labels = [
          "5 Wks Ago",
          "4 Wks Ago",
          "3 Wks Ago",
          "Last Wk",
          "This Wk",
        ];
        const data = p.wellness;
        const ctx = document.getElementById("wellnessChart");
        if (!ctx) return;
        if (wellnessChart) wellnessChart.destroy();
        wellnessChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Wellness Score",
                data,
                tension: 0.4,
                fill: true,
                backgroundColor: bgColor,
                borderWidth: 3,
                borderColor: borderColor,
                pointBackgroundColor: pointColor,
                pointBorderColor: borderColor,
                pointHoverRadius: 7,
                pointHoverBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: false,
                grid: { color: gridColor },
                ticks: { color: ticksColor },
              },
              x: {
                grid: { color: gridColor },
                ticks: { color: ticksColor },
              },
            },
            plugins: { legend: { display: false } },
          },
        });
      }

      function renderWellnessMetrics(pid) {
        const p = state.patients.find((x) => x.id === pid);
        const container = $("#wellness-metrics");
        if (!container) return;

        container.innerHTML = ""; // Clear previous metrics

        if (p && p.wellnessMetrics) {
          const metrics = [
            { label: "Weight", data: p.wellnessMetrics.weight, icon: "" },
            {
              label: "Aging Index",
              data: p.wellnessMetrics.agingIndex,
              icon: "",
            },
          ];

          container.innerHTML = metrics
            .map((metric) => {
              const change = metric.data.change;
              const isPositive = change && change.startsWith("+");
              const isNegative = change && change.startsWith("-");

              let changeColor =
                "text-text-secondary dark:text-d-text-secondary";
              if (metric.label === "Weight") {
                if (isNegative) changeColor = "text-green-500";
                if (isPositive) changeColor = "text-red-500";
              } else if (metric.label === "Aging Index") {
                if (isPositive) changeColor = "text-red-500";
                if (isNegative) changeColor = "text-green-500";
              }

              const changeSymbol = isPositive ? "↑" : isNegative ? "↓" : "";

              return `
                <div class="bg-background/50 dark:bg-slate-800/50 p-3 rounded-xl">
                    <div class="flex items-center gap-2">
                      <span class="text-lg">${metric.icon}</span>
                      <span class="text-sm font-semibold text-text-primary">${
                        metric.label
                      }</span>
                    </div>
                    <div class="flex items-baseline gap-2 mt-1">
                        <p class="text-2xl font-bold text-text-primary">${
                          metric.data.value
                        }</p>
                        ${
                          change
                            ? `<p class="text-sm font-semibold ${changeColor}">${changeSymbol} ${change.substring(
                                1
                              )}</p>`
                            : ""
                        }
                    </div>
                </div>
                `;
            })
            .join("");
        }
      }

      function renderTherapies() {
        const list = [
          {
            title: "Vamana",
            desc: "Emesis therapy for Kapha issues.",
            icon: "🌿",
            color: "bg-primary/10 dark:bg-d-primary/10",
            gradient:
              "bg-gradient-to-br from-primary/5 to-transparent dark:from-d-primary/5",
          },
          {
            title: "Virechana",
            desc: "Purgation for Pitta imbalances.",
            icon: "🪔",
            color: "bg-secondary/10 dark:bg-d-secondary/10",
            gradient:
              "bg-gradient-to-br from-secondary/5 to-transparent dark:from-d-secondary/5",
          },
          {
            title: "Basti",
            desc: "Enema therapy for Vata disorders.",
            icon: "💧",
            color: "bg-accent/10 dark:bg-d-accent/10",
            gradient:
              "bg-gradient-to-br from-accent/5 to-transparent dark:from-d-accent/5",
          },
          {
            title: "Nasya",
            desc: "Nasal therapy for head/neck.",
            icon: "🌸",
            color: "bg-tertiary/10 dark:bg-slate-600/10",
            gradient:
              "bg-gradient-to-br from-tertiary/5 to-transparent dark:from-slate-600/5",
          },
        ];
        const board = $("#therapies-board");
        if (!board) return;
        board.innerHTML = "";
        list.forEach((t) => {
          const card = document.createElement("div");
          card.className = `p-4 rounded-2xl border border-gray-200/50 dark:border-slate-700 cursor-pointer hover:shadow-lg transition-shadow flex flex-col items-center text-center therapy-card ${t.gradient}`;
          card.innerHTML = `<div class="text-3xl ${t.color} p-3 rounded-full">${t.icon}</div><div class="font-semibold mt-3 text-text-primary">${t.title}</div><div class="text-xs text-text-secondary mt-1">${t.desc}</div>`;
          card.addEventListener("click", () => openTherapyModal(t));
          board.appendChild(card);
          gsap.from(card, { scale: 0.95, opacity: 0, duration: 0.3, y: 10 });
        });
      }
      function openTherapyModal(t) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 flex items-center justify-center bg-black bg-opacity-60 z-50 p-4";
        modal.innerHTML = `<div class="bg-background dark:bg-d-surface rounded-3xl max-w-lg w-full p-8 relative"><button id="closeTherapyModal" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">✕</button><div class="text-5xl ${
          t.color
        } p-4 rounded-full inline-block mb-4">${
          t.icon
        }</div><h2 class="text-3xl font-bold mb-2">${
          t.title
        }</h2><p class="text-text-secondary">${t.desc.replace(
          "Emesis therapy for Kapha issues.",
          "Therapeutic emesis, a controlled process to eliminate toxins (kapha dosha) from the upper part of the body, primarily the stomach and chest."
        )}</p></div>`;
        document.getElementById("modal-root").appendChild(modal);
        const inner = modal.querySelector("div.relative");
        gsap.fromTo(
          inner,
          { scale: 0.9, opacity: 0 },
          { scale: 1, opacity: 1, duration: 0.3, ease: "power2.out" }
        );
        const closeBtn = modal.querySelector("#closeTherapyModal");
        if (closeBtn)
          closeBtn.addEventListener("click", () => {
            gsap.to(inner, {
              scale: 0.9,
              opacity: 0,
              duration: 0.2,
              ease: "power2.in",
              onComplete: () => modal.remove(),
            });
          });
      }
      async function handleSendLLM() {
        const issue = ($("#issue-text").value || "").trim();
        if (!issue) {
          toast(t("describeIssue"));
          return;
        }
        const loader = $("#llm-loading");
        loader.classList.remove("hidden");
        $("#llm-msg").textContent = "";
        const results = await mockLLMQuery(issue);
        loader.classList.add("hidden");
        $("#llm-msg").textContent = `${results.length} ${t(
          "suggestionsFound"
        )}`;
        renderDoctorResults(results);
      }
      function renderDoctorResults(docs) {
        const container = $("#doctor-results");
        if (!container) return;
        container.innerHTML = "";
        if (!docs || docs.length === 0) return;
        docs.forEach((d) => {
          const card = document.createElement("div");
          card.className = "p-4 rounded-2xl border border-gray-200/50 card";
          card.innerHTML = `<div><div class="font-bold text-text-primary">${
            d.name
          }</div><div class="text-xs text-text-secondary">${
            d.specialty
          }</div></div><div class="text-sm text-text-secondary mt-2">${
            d.reason
          }</div><div class="mt-4 flex items-center justify-between"><button class="choose-doc px-4 py-1.5 rounded-full btn btn-primary text-sm font-semibold" data-id="${
            d.id
          }">${t("schedule")}</button><div class="text-xs font-semibold">★ ${
            d.rating || "—"
          } (${d.exp} yrs)</div></div>`;
          container.appendChild(card);
          gsap.from(card, { scale: 0.98, opacity: 0, duration: 0.3, y: 10 });
          card
            .querySelector(".choose-doc")
            .addEventListener("click", (e) =>
              openScheduleModal(e.target.dataset.id)
            );
        });
      }

      function openClinicsModal() {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 flex items-center justify-center z-50 p-4 bg-black/60";
        modal.innerHTML = `<div class="bg-background dark:bg-d-surface rounded-3xl p-8 relative w-full max-w-lg">
                <h4 class="font-bold text-2xl mb-4" data-translate="clinicsNearYou">${t(
                  "clinicsNearYou"
                )}</h4>
                <div class="mt-6">
                    <p class="text-sm font-semibold mb-2 text-text-primary" data-translate="enterPincode">${t(
                      "enterPincode"
                    )}</p>
                    <div class="flex gap-2">
                        <input id="pincode-input" type="number" class="w-full p-3 rounded-lg border-gray-200/50 dark:border-slate-600 bg-background/50 dark:bg-slate-800/50 focus-ring" placeholder="e.g., 751024" />
                        <button id="pincode-search-btn" class="px-6 py-2 rounded-lg btn btn-primary font-semibold" data-translate="search">${t(
                          "search"
                        )}</button>
                    </div>
                </div>
                <div id="clinic-results-container" class="mt-6 max-h-[40vh] overflow-auto space-y-3 custom-scrollbar">
                </div>
                <div class="mt-6 flex justify-end gap-2">
                    <button id="modal-cancel" class="px-4 py-2 rounded-lg hover:bg-gray-200/50 dark:hover:bg-slate-700">${t(
                      "close"
                    )}</button>
                </div>
            </div>`;

        document.getElementById("modal-root").appendChild(modal);
        const inner = modal.querySelector("div.relative");
        gsap.from(inner, { y: 20, opacity: 0, duration: 0.3 });

        modal
          .querySelector("#modal-cancel")
          .addEventListener("click", () => modal.remove());
        modal
          .querySelector("#pincode-search-btn")
          .addEventListener("click", handleClinicSearch);
      }

      function handleClinicSearch() {
        const pincode = ($("#pincode-input").value || "").trim();
        if (pincode.length !== 6) {
          toast("Please enter a valid 6-digit pincode.");
          return;
        }

        const results = state.clinics.filter((c) =>
          c.pincode.startsWith(pincode.substring(0, 3))
        ); // Mock search by first 3 digits
        renderClinicResults(results);
      }

      function renderClinicResults(clinics) {
        const container = $("#clinic-results-container");
        if (!container) return;

        if (clinics.length === 0) {
          container.innerHTML = `<div class="p-4 rounded-lg border-dashed border-gray-300/80 dark:border-slate-700 text-center text-sm text-text-secondary">${t(
            "noClinicsFound"
          )}</div>`;
          return;
        }

        container.innerHTML = clinics
          .map(
            (c) => `
            <div class="p-4 rounded-xl border border-gray-200/80 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-semibold text-text-primary">${c.name}</p>
                        <p class="text-xs text-text-secondary">${c.address}, ${c.pincode}</p>
                    </div>
                    <div class="text-right flex-shrink-0 pl-4">
                        <p class="font-bold text-primary dark:text-d-primary">${c.distance}</p>
                        <p class="text-xs font-semibold text-text-secondary">★ ${c.rating}</p>
                    </div>
                </div>
            </div>
        `
          )
          .join("");
      }

      function openScheduleModal(doctorId) {
        const doc = state.practitioners.find((d) => d.id === doctorId);
        if (!doc) return;
        const p = state.patients.find((x) => x.id === state.currentUser.id);
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 flex items-center justify-center z-50 p-4 bg-black/60";
        modal.innerHTML = `<div class="bg-background dark:bg-d-surface rounded-3xl p-8 relative w-full max-w-lg"><h4 class="font-bold text-2xl">${t(
          "scheduleWith"
        ).replace(
          "{name}",
          doc.name
        )}</h4><p class="text-sm text-text-secondary">${
          doc.specialty
        }</p><div class="mt-6"><p class="text-sm font-semibold mb-2 text-text-primary">${t(
          "selectSlot"
        )}</p><div class="grid grid-cols-2 gap-2" id="slot-list">${doc.slots
          .map(
            (s) =>
              `<button class="slot-btn px-3 py-2 rounded-lg border border-gray-200/80 dark:border-slate-600 text-left hover:border-primary dark:hover:border-d-primary focus-ring" data-dt="${s}">${formatDate(
                s
              )}</button>`
          )
          .join(
            ""
          )}</div></div><div id="mode-selection" class="mt-4 pt-4 border-t border-gray-200/80 dark:border-slate-700 hidden"><p class="text-sm font-semibold mb-2 text-text-primary">${t(
          "selectMode"
        )}</p><div class="flex gap-3"><button id="confirm-physical" class="flex-1 px-3 py-2 rounded-lg bg-green-100 dark:bg-green-900/70 text-green-800 dark:text-green-200 hover:bg-green-200 font-semibold">${t(
          "confirmPhysical"
        )}</button><button id="confirm-online" class="flex-1 px-3 py-2 rounded-lg bg-blue-100 dark:bg-blue-900/70 text-blue-800 dark:text-blue-200 hover:bg-blue-200 font-semibold">${t(
          "confirmOnline"
        )}</button></div></div><div class="mt-6 flex justify-end gap-2"><button id="modal-cancel" class="px-4 py-2 rounded-lg hover:bg-gray-200/50 dark:hover:bg-slate-700">${t(
          "close"
        )}</button></div></div>`;
        document.getElementById("modal-root").appendChild(modal);
        const inner = modal.querySelector("div.relative");
        gsap.from(inner, { y: 20, opacity: 0, duration: 0.3 });
        let selectedDateTime = null;
        modal.querySelectorAll(".slot-btn").forEach((b) => {
          b.addEventListener("click", () => {
            selectedDateTime = b.dataset.dt;
            modal.querySelectorAll(".slot-btn").forEach((btn) => {
              btn.classList.remove(
                "bg-primary",
                "text-white",
                "border-primary"
              );
              btn.classList.remove(
                "dark:bg-d-primary",
                "dark:border-d-primary"
              );
            });
            b.classList.add("bg-primary", "text-white", "border-primary");
            b.classList.add("dark:bg-d-primary", "dark:border-d-primary");
            $("#mode-selection").classList.remove("hidden");
          });
        });
        modal.querySelector("#modal-cancel").addEventListener("click", () => modal.remove());
        modal
          .querySelector("#confirm-physical")
          .addEventListener("click", () => {
            if (selectedDateTime) {
              modal.remove();
              openPaymentModal(p.id, doctorId, selectedDateTime, "Physical");
            }
          });
        modal.querySelector("#confirm-online").addEventListener("click", () => {
          if (selectedDateTime) {
            modal.remove();
            openPaymentModal(p.id, doctorId, selectedDateTime, "Online");
          }
        });
      }

      function openPaymentModal(pid, did, datetime, mode) {
        const doc = state.practitioners.find((d) => d.id === did);
        if (!doc) return;
        const price = mode === "Physical" ? 800 : 500;
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 flex items-center justify-center z-50 p-4 bg-black/60";
        modal.innerHTML = `
            <div class="bg-background dark:bg-d-surface rounded-3xl p-8 relative w-full max-w-sm text-center">
                <h4 class="font-bold text-2xl">Confirm Booking</h4>
                <p class="text-sm text-text-secondary mt-2">
                    You are booking a ${mode} consultation with ${
          doc.name
        } on ${formatDate(datetime)}.
                </p>
                <div class="my-6 p-4 bg-primary/10 dark:bg-d-primary/10 rounded-xl">
                    <p class="text-sm text-text-secondary">Total Amount</p>
                    <p class="text-4xl font-bold text-primary dark:text-d-primary">₹${price}</p>
                </div>
                <p class="text-xs text-text-secondary mb-6">
                    This is a mock payment step. No real transaction will occur.
                </p>
                <div class="flex flex-col gap-3">
                    <button id="confirm-pay-btn" class="w-full py-3 rounded-full btn btn-primary font-semibold text-lg">
                        Confirm & Pay
                    </button>
                    <button id="payment-cancel-btn" class="w-full py-2 rounded-full font-semibold text-text-secondary hover:bg-gray-200/50 dark:hover:bg-slate-700">
                        Cancel
                    </button>
                </div>
            </div>`;
        document.getElementById("modal-root").appendChild(modal);

        const inner = modal.querySelector("div.relative");
        gsap.from(inner, { y: 20, opacity: 0, duration: 0.3 });

        modal
          .querySelector("#confirm-pay-btn")
          .addEventListener("click", () => {
            confirmSchedule(pid, did, datetime, mode, modal);
          });

        modal
          .querySelector("#payment-cancel-btn")
          .addEventListener("click", () => {
            gsap.to(inner, {
              y: 20,
              opacity: 0,
              duration: 0.2,
              onComplete: () => modal.remove(),
            });
          });
      }

      function confirmSchedule(pid, did, datetime, mode, modalEl) {
        const newId = "A-" + (100 + state.appointments.length + 1);
        const appt = {
          id: newId,
          patientId: pid,
          doctorId: did,
          datetime,
          therapy: "Consult",
          status: "Scheduled",
          mode: mode,
        };
        state.appointments.push(appt);
        const p = state.patients.find((x) => x.id === pid);
        if (p) p.appointments.push(appt);
        if (modalEl && modalEl.remove) {
          const inner = modalEl.querySelector("div.relative");
          if (inner) {
            gsap.to(inner, {
              y: 20,
              opacity: 0,
              duration: 0.2,
              onComplete: () => modalEl.remove(),
            });
          } else {
            modalEl.remove();
          }
        }
        renderUpcomingSession(pid);
        populatePatientInfo(pid);
        toast(t("appointmentScheduled"));
      }

      function openHistoryModal(pid) {
        const p = state.patients.find((x) => x.id === pid);
        if (!p) return;
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 flex items-center justify-center z-50 p-4 bg-black/60";
        modal.innerHTML = `<div class="bg-background dark:bg-d-surface rounded-3xl p-8 relative w-full max-w-2xl max-h-[80vh] overflow-auto custom-scrollbar"><h4 class="font-bold text-2xl">${t(
          "history"
        )} — ${
          p.name
        }</h4><div id="history-list" class="mt-6 space-y-4"></div><div class="mt-6 flex justify-end gap-2"><button id="history-close" class="px-4 py-2 rounded-lg hover:bg-gray-200/50 dark:hover:bg-slate-700">${t(
          "close"
        )}</button></div></div>`;
        document.getElementById("modal-root").appendChild(modal);
        const listEl = modal.querySelector("#history-list");
        if ((p.history || []).length === 0)
          listEl.innerHTML = `<div class="text-sm text-text-secondary">${t(
            "noHistory"
          )}</div>`;
        else {
          const sortedHistory = p.history.sort(
            (a, b) => new Date(b.date) - new Date(a.date)
          );
          sortedHistory.forEach((h, idx) => {
            const row = document.createElement("div");
            row.className =
              "p-4 rounded-xl border border-gray-200/80 dark:border-slate-700";
            const feedbackExists = state.feedback.some(
              (f) =>
                f.patientId === p.id &&
                f.practitionerName === h.practitioner &&
                f.date === h.date
            );
            row.innerHTML = `<div><strong class="text-text-primary">${
              h.therapy
            }</strong> on ${new Date(h.date).toLocaleDateString("en-IN", {
              dateStyle: "long",
            })} • ${h.practitioner}</div>
              <div class="flex items-center gap-2 mt-2">
                <button class="download-pres text-sm px-3 py-1 rounded-md bg-secondary/20 dark:bg-orange-400/20 font-semibold" data-idx="${idx}">Prescription</button>
                <button class="feedback-btn text-sm px-3 py-1 rounded-md ${
                  feedbackExists
                    ? "bg-gray-200/50 text-gray-500 cursor-not-allowed"
                    : "bg-primary/20 dark:bg-d-primary/20 font-semibold"
                }" data-idx="${idx}" ${feedbackExists ? "disabled" : ""}>${
              feedbackExists ? t("feedbackSent") : t("giveFeedback")
            }</button>
              </div>
              <p class="text-sm text-text-secondary mt-2">${
                h.prescription
              }</p>`;
            listEl.appendChild(row);
          });
        }
        modal
          .querySelector("#history-close")
          .addEventListener("click", () => modal.remove());
        modal.querySelectorAll(".download-pres").forEach((b) =>
          b.addEventListener("click", (e) => {
            const idx = e.target.dataset.idx;
            const h = p.history.sort(
              (a, b) => new Date(b.date) - new Date(a.date)
            )[idx];
            downloadPrescription(
              h.prescription,
              `${p.id}_${h.therapy}_prescription.txt`
            );
          })
        );
        modal.querySelectorAll(".feedback-btn:not([disabled])").forEach((b) => {
          b.addEventListener("click", (e) => {
            const idx = e.target.dataset.idx;
            const historyItem = p.history.sort(
              (a, b) => new Date(b.date) - new Date(a.date)
            )[idx];
            modal.remove(); // Close the history modal
            openFeedbackModal(p.id, historyItem);
          });
        });

        const inner = modal.querySelector("div.relative");
        gsap.from(inner, { y: 20, opacity: 0, duration: 0.3 });
      }

      function openFeedbackModal(patientId, historyItem) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 flex items-center justify-center z-50 p-4 bg-black/60";
        modal.innerHTML = `
            <div class="bg-background dark:bg-d-surface rounded-3xl p-8 relative w-full max-w-lg">
                <h4 class="font-bold text-2xl" data-translate="giveFeedbackFor">${t(
                  "giveFeedbackFor"
                )}</h4>
                <div class="mt-2 p-3 bg-background/50 dark:bg-slate-800/50 rounded-lg border border-gray-200/50 dark:border-slate-700">
                    <p class="font-semibold">${historyItem.therapy}</p>
                    <p class="text-sm text-text-secondary">with ${
                      historyItem.practitioner
                    } on ${new Date(historyItem.date).toLocaleDateString(
          "en-IN",
          { dateStyle: "long" }
        )}</p>
                </div>

                <div class="mt-6">
                    <p class="text-sm font-semibold mb-2 text-text-primary" data-translate="yourRating">${t(
                      "yourRating"
                    )}</p>
                    <div id="feedback-rating" class="flex items-center gap-2 text-3xl cursor-pointer">
                        <span data-value="1" class="star text-gray-300 dark:text-gray-600">★</span>
                        <span data-value="2" class="star text-gray-300 dark:text-gray-600">★</span>
                        <span data-value="3" class="star text-gray-300 dark:text-gray-600">★</span>
                        <span data-value="4" class="star text-gray-300 dark:text-gray-600">★</span>
                        <span data-value="5" class="star text-gray-300 dark:text-gray-600">★</span>
                    </div>
                </div>

                <div class="mt-6">
                    <p class="text-sm font-semibold mb-2 text-text-primary" data-translate="yourComments">${t(
                      "yourComments"
                    )}</p>
                    <textarea id="feedback-comment" rows="4" class="w-full p-3 rounded-lg border-gray-200/50 dark:border-slate-600 bg-background/50 dark:bg-slate-800/50 focus-ring" placeholder="${t(
                      "feedbackPlaceholder"
                    )}"></textarea>
                </div>

                <div class="mt-6 flex justify-end gap-2">
                    <button id="feedback-cancel" class="px-5 py-2 rounded-lg hover:bg-gray-200/50 dark:hover:bg-slate-700 font-semibold">${t(
                      "close"
                    )}</button>
                    <button id="feedback-submit" class="px-5 py-2 rounded-lg btn btn-primary font-semibold" data-translate="submitFeedback">${t(
                      "submitFeedback"
                    )}</button>
                </div>
            </div>
        `;
        document.getElementById("modal-root").appendChild(modal);

        const inner = modal.querySelector("div.relative");
        gsap.from(inner, { y: 20, opacity: 0, duration: 0.3 });

        let currentRating = 0;
        const stars = modal.querySelectorAll(".star");

        const setRating = (rating) => {
          currentRating = rating;
          stars.forEach((star) => {
            if (parseInt(star.dataset.value) <= rating) {
              star.classList.add("text-amber-400");
              star.classList.remove("text-gray-300", "dark:text-gray-600");
            } else {
              star.classList.remove("text-amber-400");
              star.classList.add("text-gray-300", "dark:text-gray-600");
            }
          });
        };

        stars.forEach((star) => {
          star.addEventListener("click", () =>
            setRating(parseInt(star.dataset.value))
          );
        });

        modal
          .querySelector("#feedback-cancel")
          .addEventListener("click", () => modal.remove());
        modal
          .querySelector("#feedback-submit")
          .addEventListener("click", () => {
            const comment = modal
              .querySelector("#feedback-comment")
              .value.trim();
            if (currentRating === 0) {
              toast("Please provide a rating.");
              return;
            }
            if (comment === "") {
              toast("Please provide a comment.");
              return;
            }

            const newFeedback = {
              patientId,
              practitionerName: historyItem.practitioner,
              therapy: historyItem.therapy,
              date: historyItem.date,
              rating: currentRating,
              comment,
            };

            state.feedback.push(newFeedback);
            modal.remove();
            toast(t("feedbackSubmitted"));
          });
      }

      function downloadPrescription(text, filename) {
        const blob = new Blob([text], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        toast(t("downloadStarted"));
      }

      function openEducationModal() {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 flex items-center justify-center z-50 p-4 bg-black/60";
        modal.innerHTML = `
            <div class="bg-background dark:bg-d-surface rounded-3xl p-8 relative w-full max-w-4xl max-h-[90vh] flex gap-6">
                <div id="edu-nav" class="w-1/4 space-y-2">
                    <h4 class="font-bold text-2xl mb-4" data-translate="educationHub">${t(
                      "educationHub"
                    )}</h4>
                    <button class="edu-nav-item active w-full text-left p-3 rounded-lg">Understanding Doshas</button>
                     <button class="edu-nav-item w-full text-left p-3 rounded-lg">Panchakarma Therapies</button>
                    <button class="edu-nav-item w-full text-left p-3 rounded-lg">Ayurvedic Recipes</button>
                </div>
                <div id="edu-content" class="w-3/4 overflow-auto custom-scrollbar">
                </div>
                 <button id="edu-close" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">✕</button>
            </div>`;
        document.getElementById("modal-root").appendChild(modal);

        const inner = modal.querySelector("div.relative");
        gsap.from(inner, { y: 20, opacity: 0, duration: 0.3 });

        const contentEl = modal.querySelector("#edu-content");
        const navItems = modal.querySelectorAll(".edu-nav-item");

        const articles = {
          "Understanding Doshas": `
                <h5 class="text-2xl font-bold mb-4">The Three Doshas: Vata, Pitta, and Kapha</h5>
                <p class="mb-4">In Ayurveda, the three doshas are energies that make up every individual. While everyone has some of each, most people tend to have a dominance of one or two. The doshas are: </p>
                <ul class="list-disc list-inside space-y-2 mb-4">
                    <li><strong>Vata (Air and Ether):</strong> Characterized by qualities of being light, cold, dry, and mobile. Vata governs movement in the body, the activities of the nervous system, and the process of elimination.</li>
                    <li><strong>Pitta (Fire and Water):</strong> Characterized by being hot, sharp, and oily. Pitta governs digestion, absorption, assimilation, metabolism, and body temperature.</li>
                    <li><strong>Kapha (Earth and Water):</strong> Characterized by being heavy, slow, steady, and cool. Kapha governs the structure of the body. It is the principle that holds the cells together and forms the muscle, fat, bone, and sinew.</li>
                </ul>
                <p>Understanding your dominant dosha can help you make lifestyle and diet choices that support balance and health.</p>`,
          "Panchakarma Therapies": `
                <h5 class="text-2xl font-bold mb-4">An Introduction to Panchakarma</h5>
                <p class="mb-4">Panchakarma is a method of cleansing the body of all unwanted waste out of the body. It's a cornerstone of Ayurvedic medicine and consists of five main procedures:</p>
                <ul class="list-disc list-inside space-y-2">
                    <li><strong>Vamana:</strong> Therapeutic vomiting or emesis.</li>
                    <li><strong>Virechana:</strong> Purgation.</li>
                    <li><strong>Basti:</strong> Medicated enema.</li>
                    <li><strong>Nasya:</strong> Nasal administration of medicine.</li>
                    <li><strong>Raktamokshana:</strong> Bloodletting or detoxification of the blood.</li>
                </ul>`,
          "Ayurvedic Recipes": `
                 <h5 class="text-2xl font-bold mb-4">Simple Kitchari Recipe</h5>
                <p class="mb-4">Kitchari is a simple, nourishing porridge that is easy to digest and is a staple in Ayurvedic cleansing.</p>
                <p class="font-semibold">Ingredients:</p>
                <ul class="list-disc list-inside space-y-1 mb-4">
                    <li>1 cup yellow mung dal</li>
                    <li>1/2 cup basmati rice</li>
                    <li>6 cups water</li>
                    <li>1 tbsp ghee</li>
                    <li>1 tsp cumin seeds</li>
                    <li>1 tsp mustard seeds</li>
                    <li>1/2 tsp turmeric powder</li>
                    <li>Fresh ginger, grated (to taste)</li>
                    <li>Salt to taste</li>
                </ul>
                <p class="font-semibold">Instructions:</p>
                <p>Wash dal and rice together until water runs clear. Heat ghee in a pot, add seeds until they pop. Add ginger and turmeric. Stir in rice and dal, then add water and salt. Bring to a boil, then simmer until tender (about 45 minutes).</p>
            `,
        };

        function loadContent(topic) {
          contentEl.innerHTML = articles[topic];
          navItems.forEach((item) => {
            item.classList.toggle("active", item.textContent === topic);
            item.classList.toggle("bg-primary/10", item.textContent === topic);
            item.classList.toggle(
              "dark:bg-d-primary/10",
              item.textContent === topic
            );
          });
        }

        navItems.forEach((item) => {
          item.addEventListener("click", () => loadContent(item.textContent));
        });

        loadContent("Understanding Doshas"); // Load default content

        modal.querySelector("#edu-close").addEventListener("click", () => {
          gsap.to(inner, {
            y: 20,
            opacity: 0,
            duration: 0.2,
            onComplete: () => modal.remove(),
          });
        });
      }
      
      // PRACTITIONER DASHBOARD FUNCTIONS
      function showPractitionerDashboard(practId) {
        $("#app-title").textContent = t("practitionerDashboardTitle");
        $("#dashboard-patient").classList.add("hidden");
        $("#dashboard-practitioner").classList.remove("hidden");
        $("#btn-find-clinics")?.classList.add("hidden");
        $("#btn-learn")?.classList.add("hidden");
        renderPractPatientList();
        renderCalendar(practId, state.currentCalendarDate);
        renderRecentFeedback(practId);
        applyTranslations();
        gsap.from("#dashboard-practitioner .card", {
          y: 20,
          opacity: 0,
          duration: 0.4,
          stagger: 0.08,
        });
      }

      function renderRecentFeedback(practId) {
        const practitioner = state.practitioners.find((p) => p.id === practId);
        if (!practitioner) return;

        const listEl = $("#pract-feedback-list");
        if (!listEl) return;
        listEl.innerHTML = "";

        const feedbacks = state.feedback
          .filter((f) => f.practitionerName === practitioner.name)
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        if (feedbacks.length === 0) {
          listEl.innerHTML = `<div class="text-center text-text-secondary py-6">No feedback received yet.</div>`;
          return;
        }

        const feedbackHtml = feedbacks
          .map((f) => {
            const patient = state.patients.find((p) => p.id === f.patientId);
            const ratingStars = "★".repeat(f.rating) + "☆".repeat(5 - f.rating);
            return `
                <div class="p-4 rounded-xl border border-gray-200/80 dark:border-slate-700">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="font-semibold text-text-primary">${
                              patient ? patient.name : f.patientId
                            } <span class="text-sm font-normal text-text-secondary">re: ${
              f.therapy
            }</span></p>
                            <p class="text-xs text-text-secondary">${new Date(
                              f.date
                            ).toLocaleDateString("en-IN", {
                              dateStyle: "long",
                            })}</p>
                        </div>
                        <div class="text-amber-400 font-bold text-lg" title="Rating: ${
                          f.rating
                        }/5">${ratingStars}</div>
                    </div>
                    <p class="text-sm text-text-secondary mt-2 italic">"${
                      f.comment
                    }"</p>
                </div>
            `;
          })
          .join("");
        listEl.innerHTML = feedbackHtml;
      }

      function renderPractPatientList(filter = "") {
        const list = $("#pract-patient-list");
        if (!list) return;
        list.innerHTML = "";
        const filtered = state.patients.filter(
          (p) =>
            p.name.toLowerCase().includes(filter.toLowerCase()) ||
            p.id.toLowerCase().includes(filter.toLowerCase())
        );
        filtered.forEach((p) => {
          const el = document.createElement("div");
          el.className =
            "p-3 rounded-xl border border-gray-200/50 dark:border-slate-700 flex items-center justify-between cursor-pointer hover:bg-white/50 dark:hover:bg-slate-800/50";
          el.innerHTML = `<div><div class="font-semibold text-sm text-text-primary">${
            p.name
          }</div><div class="text-xs text-text-secondary">${p.id} • ${
            p.conditions[0] || ""
          }</div></div><span class="p-1 text-text-secondary">→</span>`;
          el.addEventListener("click", () => openPractSlide(p.id));
          list.appendChild(el);
        });
      }
      function renderCalendar(practId, date) {
        const grid = $("#calendar-grid");
        const title = $("#calendar-title");
        grid.innerHTML = "";

        const month = date.getMonth();
        const year = date.getFullYear();

        title.textContent = date.toLocaleDateString("en-IN", {
          month: "long",
          year: "numeric",
        });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Day headers
        ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].forEach((day) => {
          grid.innerHTML += `<div class="font-bold text-text-secondary">${day}</div>`;
        });

        // Blank days
        for (let i = 0; i < firstDay; i++) {
          grid.innerHTML += "<div></div>";
        }

        // Dates
        for (let i = 1; i <= daysInMonth; i++) {
          const today = new Date();
          const isToday =
            i === today.getDate() &&
            month === today.getMonth() &&
            year === today.getFullYear();
          const dayAppointments = state.appointments.filter((a) => {
            const apptDate = new Date(a.datetime);
            return (
              a.doctorId === practId &&
              apptDate.getDate() === i &&
              apptDate.getMonth() === month &&
              apptDate.getFullYear() === year
            );
          });

          grid.innerHTML += `
                <div class="p-1 border-t border-gray-200/50 dark:border-slate-700/50 min-h-[80px]">
                    <div class="font-semibold ${
                      isToday
                        ? "bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center mx-auto"
                        : ""
                    }">${i}</div>
                     <div class="text-xs mt-1 space-y-1">
                        ${dayAppointments
                          .map(
                            (a) =>
                              `<button data-appid="${
                                a.id
                              }" class="cal-appointment-btn w-full text-left bg-secondary/20 hover:bg-secondary/40 dark:bg-d-secondary/20 dark:hover:bg-d-secondary/40 p-1 rounded-md truncate" title="${
                                a.therapy
                              } with ${
                                state.patients.find((p) => p.id === a.patientId)
                                  ?.name || ""
                              }">${a.therapy}</button>`
                          )
                          .join("")}
                    </div>
                </div>`;
        }

        grid.querySelectorAll(".cal-appointment-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const appId = e.currentTarget.dataset.appid;
            openAppointmentDetail(appId);
          });
        });
      }

      function openAppointmentDetail(aid) {
        const appt = state.appointments.find((a) => a.id === aid);
        if (!appt) return;
        openPractSlide(appt.patientId, appt);
      }
      function openPractSlide(pid, appt = null) {
        const p = state.patients.find((x) => x.id === pid);
        if (!p) return;
        const body = $("#pract-slide-body");
        if (!body) return;
        body.innerHTML = "";
        body.innerHTML += `<div class="font-bold text-xl text-text-primary">${p.name}</div><div class="text-sm text-text-secondary">${p.id}</div>`;
        body.innerHTML += `<div class="mt-4 text-sm"><strong class="text-text-primary">${t("contact")}:</strong> ${p.contact}</div>`;
        body.innerHTML += `<div class="mt-2 text-sm"><strong class="text-text-primary">${t("conditions")}:</strong> ${p.conditions.join(", ")}</div>`;
        body.innerHTML += `<div class="mt-4"><strong class="text-text-primary">${t("history")}</strong><div class="mt-2 space-y-2 max-h-48 overflow-auto custom-scrollbar">${p.history
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .map(
            (h) =>
              `<div class="p-3 rounded-lg border border-gray-200/80 dark:border-slate-700 text-sm"><div><strong class="text-text-primary">${
                h.therapy
              }</strong> on ${new Date(
                h.date
              ).toLocaleDateString()}</div><div class="text-xs text-text-secondary">with ${
                h.practitioner
              }</div></div>`
          )
          .join("")}</div></div>`;
        if (appt) {
          body.innerHTML += `<div class="mt-4 pt-4 border-t border-gray-200/80 dark:border-slate-700"><strong class="text-text-primary">${t("selectedAppointment")}</strong><div class="p-3 rounded-lg border-l-4 border-primary dark:border-d-primary mt-2 text-sm bg-primary/5 dark:bg-d-primary/5"><div>${
            appt.therapy
          } - ${
            appt.status
          }</div><div class="text-xs text-text-secondary">${formatDate(
            appt.datetime
          )}</div></div></div>`;
          body.innerHTML += `<div class="mt-4 flex gap-2"><button id="mark-completed" class="px-4 py-2 rounded-lg btn btn-primary text-sm font-semibold">${t("markCompleted")}</button><button id="add-note" class="px-4 py-2 rounded-lg bg-white dark:bg-slate-700 border dark:border-slate-600 text-sm font-semibold">${t("addNote")}</button></div>`;
        }
        
        // NEW: Add Message button to slide-out
        body.innerHTML += `<div class="mt-4 pt-4 border-t border-gray-200/80 dark:border-slate-700"><button id="message-patient-btn" data-patient-id="${p.id}" class="w-full py-2 rounded-lg btn btn-secondary font-semibold">Message ${p.name.split(' ')[0]}</button></div>`;

        const slide = $("#pract-slide");
        if (slide) {
          slide.removeAttribute("style");
          slide.classList.remove("hidden");
        }
        gsap.from("#pract-slide", { x: 60, opacity: 0, duration: 0.4, ease: "power2.out" });

        $("#mark-completed")?.addEventListener("click", () => {
            if (appt) {
                const a = state.appointments.find((ap) => ap.id === appt.id);
                if (a) a.status = "Completed";
                toast(t("markedCompleted"));
                renderCalendar(state.currentUser.id, state.currentCalendarDate);
                openPractSlide(pid, a);
            }
        });

        $("#message-patient-btn")?.addEventListener("click", (e) => {
            const patientId = e.currentTarget.dataset.patientId;
            hidePractSlide();
            openChatModal(patientId);
        });
      }
      function hidePractSlide() {
        gsap.to("#pract-slide", {
          x: 60,
          opacity: 0,
          duration: 0.3,
          ease: "power2.in",
          onComplete: () => $("#pract-slide").classList.add("hidden"),
        });
      }
      function handlePractSearch() {
        const q = ($("#pract-search").value || "").trim();
        renderPractPatientList(q);
      }
      function openInfoModal(title, content) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 flex items-center justify-center z-50 p-4 bg-black/60";
        modal.innerHTML = `<div class="bg-background dark:bg-d-surface rounded-3xl p-8 relative w-full max-w-md"><h4 class="font-bold text-2xl mb-4">${title}</h4><div class="text-sm text-text-secondary">${content}</div><div class="mt-6 flex justify-end gap-2"><button id="modal-close" class="px-5 py-2 rounded-lg btn btn-primary font-semibold">${t(
          "close"
        )}</button></div></div>`;
        document.getElementById("modal-root").appendChild(modal);
        const inner = modal.querySelector("div.relative");
        gsap.from(inner, { y: 20, opacity: 0, duration: 0.3 });
        modal.querySelector("#modal-close").addEventListener("click", () =>
          gsap.to(inner, {
            y: 20,
            opacity: 0,
            duration: 0.2,
            onComplete: () => modal.remove(),
          })
        );
      }

       // --- NEW FEATURE FUNCTIONS ---

      // 1. NOTIFICATIONS
      function populateNotifications(userId) {
          state.notifications = []; // Clear old notifications
          const upcoming = state.appointments.filter(a => (a.patientId === userId || a.doctorId === userId) && new Date(a.datetime) > new Date());
          
          upcoming.forEach(appt => {
              const otherPartyId = appt.patientId === userId ? appt.doctorId : appt.patientId;
              const otherParty = appt.patientId === userId ? state.practitioners.find(p => p.id === otherPartyId) : state.patients.find(p => p.id === otherPartyId);
              
              state.notifications.push({
                  id: `notif-${appt.id}`,
                  userId: userId,
                  title: `Appointment Reminder`,
                  body: `Your session with ${otherParty.name} is scheduled for ${formatDate(appt.datetime)}.`,
                  timestamp: new Date(new Date(appt.datetime).getTime() - 24 * 60 * 60 * 1000).toISOString(), // 24 hours before
                  read: false
              });
          });
          state.notifications.push({
              id: 'notif-feedback',
              userId: 'P-001',
              title: 'Feedback Request',
              body: 'How was your recent "Abhyanga" therapy? Please provide your feedback.',
              timestamp: '2025-09-20T11:00:00',
              read: true
          });
          renderNotifications();
      }

      function renderNotifications() {
          const listEl = $("#notification-list");
          const indicator = $("#notification-indicator");
          if (!listEl || !indicator) return;

          const userNotifications = state.notifications.filter(n => n.userId === state.currentUser?.id).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
          const unreadCount = userNotifications.filter(n => !n.read).length;

          indicator.classList.toggle('hidden', unreadCount === 0);

          if (userNotifications.length === 0) {
              listEl.innerHTML = `<p class="p-4 text-sm text-text-secondary text-center">No new notifications.</p>`;
              return;
          }

          listEl.innerHTML = userNotifications.map(n => `
              <div class="p-4 border-b border-gray-200/50 dark:border-slate-700/50 hover:bg-gray-100/50 dark:hover:bg-slate-800/50 cursor-pointer ${!n.read ? 'bg-primary/5 dark:bg-d-primary/5' : ''}">
                  <p class="font-semibold text-text-primary">${n.title}</p>
                  <p class="text-sm text-text-secondary">${n.body}</p>
                  <p class="text-xs text-text-secondary mt-1">${timeSince(n.timestamp)}</p>
              </div>
          `).join('');
      }

      function toggleNotificationPopover() {
          const popover = $("#notification-popover");
          popover.classList.toggle('hidden');
          if (!popover.classList.contains('hidden')) {
              gsap.from(popover, { opacity: 0, y: -10, duration: 0.2 });
              // Mark all as read when opened
              state.notifications.forEach(n => { if (n.userId === state.currentUser?.id) n.read = true; });
              setTimeout(renderNotifications, 300);
          }
      }

      // 2. DOCUMENT UPLOADS
      function renderDocuments(patientId) {
          const patient = state.patients.find(p => p.id === patientId);
          const listEl = $("#document-list");
          if (!patient || !listEl) return;
          
          if (!patient.documents || patient.documents.length === 0) {
              listEl.innerHTML = `<div class="p-4 rounded-lg border-dashed border-gray-300/80 dark:border-slate-600 text-center text-sm text-text-secondary">No documents uploaded.</div>`;
              return;
          }
          
          listEl.innerHTML = patient.documents.map(doc => `
              <div class="p-3 rounded-xl border border-gray-200/50 dark:border-slate-700 flex items-center justify-between bg-white/30 dark:bg-slate-800/30">
                  <div class="flex items-center gap-3">
                      <svg class="w-6 h-6 text-primary dark:text-d-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                      <div>
                          <p class="font-semibold text-sm text-text-primary">${doc.name}</p>
                          <p class="text-xs text-text-secondary">Uploaded on ${doc.date}</p>
                      </div>
                  </div>
                  <button class="px-3 py-1 rounded-md bg-secondary/20 hover:bg-secondary/30 text-sm font-semibold">View</button>
              </div>
          `).join('');
      }

      function handleDocumentUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          const patient = state.patients.find(p => p.id === state.currentUser.id);
          if (patient) {
              const newDoc = {
                  id: `DOC-0${patient.documents.length + 3}`,
                  name: file.name,
                  date: new Date().toISOString().split('T')[0],
                  type: file.type.split('/')[1]
              };
              patient.documents.unshift(newDoc); // Add to beginning of array
              renderDocuments(patient.id);
              toast('Document uploaded successfully!');
          }
          // Reset file input
          event.target.value = '';
      }
      
      // 3. CHAT / MESSAGING
      function openChatModal(contactId = null) {
          const modal = document.createElement('div');
          modal.id = 'chat-modal';
          modal.className = "fixed inset-0 flex items-center justify-center z-50 p-4 bg-black/60";
          
          modal.innerHTML = `
            <div class="bg-background dark:bg-d-surface rounded-3xl relative w-full max-w-4xl h-[85vh] flex overflow-hidden">
                <div id="chat-sidebar" class="w-1/3 border-r border-gray-200/50 dark:border-slate-700 flex flex-col">
                    <div class="p-4 border-b border-gray-200/50 dark:border-slate-700">
                        <h4 class="font-bold text-xl">Messages</h4>
                    </div>
                    <div id="chat-contact-list" class="flex-1 overflow-y-auto custom-scrollbar"></div>
                </div>
                <div id="chat-main" class="w-2/3 flex flex-col">
                    <div id="chat-welcome" class="flex-1 flex flex-col items-center justify-center text-center p-8">
                         <svg class="w-24 h-24 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                         <h3 class="text-xl font-semibold mt-4">Your Conversations</h3>
                         <p class="text-text-secondary mt-1">Select a conversation to start chatting.</p>
                    </div>
                    <div id="chat-conversation" class="hidden flex-1 flex flex-col">
                         <!-- Conversation will be rendered here -->
                    </div>
                </div>
                <button id="chat-close" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">✕</button>
            </div>
          `;
          $('#modal-root').appendChild(modal);

          const inner = modal.querySelector('div.relative');
          gsap.from(inner, { scale: 0.95, opacity: 0, duration: 0.3 });
          
          modal.querySelector('#chat-close').addEventListener('click', () => {
              gsap.to(inner, { scale: 0.95, opacity: 0, duration: 0.2, onComplete: () => modal.remove() });
          });

          renderChatContacts(contactId);
          if (contactId) {
              renderConversation(contactId);
          }
      }

      function renderChatContacts(activeContactId = null) {
          const listEl = $('#chat-contact-list');
          const userId = state.currentUser.id;
          
          const myMessages = state.messages.filter(m => m.participants.includes(userId));
          
          if(myMessages.length === 0) {
              listEl.innerHTML = `<p class="p-4 text-center text-sm text-text-secondary">No conversations yet.</p>`;
              return;
          }

          listEl.innerHTML = myMessages.map(msg => {
              const otherId = msg.participants.find(p => p !== userId);
              const otherUser = state.patients.find(p => p.id === otherId) || state.practitioners.find(p => p.id === otherId);
              const lastMessage = msg.conversation[msg.conversation.length - 1];

              return `
                  <div class="chat-contact-item p-4 flex items-center gap-3 cursor-pointer hover:bg-gray-100/50 dark:hover:bg-slate-800/50 border-b border-gray-200/50 dark:border-slate-700/50 ${otherId === activeContactId ? 'bg-primary/10 dark:bg-d-primary/10' : ''}" data-contact-id="${otherId}">
                      <div class="w-10 h-10 rounded-full bg-secondary/20 flex items-center justify-center font-bold text-secondary">${otherUser.name.charAt(0)}</div>
                      <div class="flex-1 overflow-hidden">
                          <p class="font-semibold text-text-primary truncate">${otherUser.name}</p>
                          <p class="text-sm text-text-secondary truncate">${lastMessage.text}</p>
                      </div>
                  </div>
              `;
          }).join('');

          listEl.querySelectorAll('.chat-contact-item').forEach(item => {
              item.addEventListener('click', (e) => {
                  const contactId = e.currentTarget.dataset.contactId;
                  renderConversation(contactId);
                  // Update active state visuals
                  listEl.querySelectorAll('.chat-contact-item').forEach(i => i.classList.remove('bg-primary/10', 'dark:bg-d-primary/10'));
                  e.currentTarget.classList.add('bg-primary/10', 'dark:bg-d-primary/10');
              });
          });
      }

      function renderConversation(contactId) {
          $('#chat-welcome').classList.add('hidden');
          const container = $('#chat-conversation');
          container.classList.remove('hidden');
          container.classList.add('flex');

          const userId = state.currentUser.id;
          const otherUser = state.patients.find(p => p.id === contactId) || state.practitioners.find(p => p.id === contactId);
          const conversationData = state.messages.find(m => m.participants.includes(userId) && m.participants.includes(contactId));
          
          const messagesHtml = conversationData ? conversationData.conversation.map(msg => {
              const isMe = msg.sender === userId;
              return `
                  <div class="flex ${isMe ? 'justify-end' : 'justify-start'} mb-3">
                      <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${isMe ? 'bg-primary text-white rounded-br-lg' : 'bg-gray-200/80 dark:bg-slate-700 text-text-primary rounded-bl-lg'}">
                          <p>${msg.text}</p>
                      </div>
                  </div>
              `;
          }).join('') : '';

          container.innerHTML = `
              <div class="p-4 border-b border-gray-200/50 dark:border-slate-700 flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-secondary/20 flex items-center justify-center font-bold text-secondary">${otherUser.name.charAt(0)}</div>
                  <div>
                      <p class="font-semibold text-text-primary">${otherUser.name}</p>
                      <p class="text-xs text-text-secondary">${otherUser.specialty || 'Patient'}</p>
                  </div>
              </div>
              <div id="chat-messages" class="flex-1 p-4 overflow-y-auto custom-scrollbar">
                  ${messagesHtml}
              </div>
              <div class="p-4 border-t border-gray-200/50 dark:border-slate-700 flex items-center gap-2">
                  <input id="chat-input" class="w-full p-3 rounded-full border-gray-200/50 dark:border-slate-600 bg-gray-100/50 dark:bg-slate-800/50 focus-ring" placeholder="Type a message..." />
                  <button id="chat-send-btn" class="p-3 rounded-full btn btn-primary flex-shrink-0">
                      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
                  </button>
              </div>
          `;
          
          const messagesContainer = $('#chat-messages');
          messagesContainer.scrollTop = messagesContainer.scrollHeight;

          $('#chat-send-btn').addEventListener('click', () => handleSendMessage(contactId));
          $('#chat-input').addEventListener('keypress', (e) => {
              if (e.key === 'Enter') handleSendMessage(contactId);
          });
      }

      function handleSendMessage(contactId) {
          const input = $('#chat-input');
          const text = input.value.trim();
          if (!text) return;

          const userId = state.currentUser.id;
          const conversationData = state.messages.find(m => m.participants.includes(userId) && m.participants.includes(contactId));

          if (conversationData) {
              conversationData.conversation.push({
                  sender: userId,
                  text: text,
                  timestamp: new Date().toISOString()
              });
              input.value = '';
              renderConversation(contactId);
          }
      }


      init();
    </script>
  </body>
</html>

